<script>
    // --- DOM Elements ---
    const dom = {
        userPoints: document.getElementById('userPoints'),
        rewardsGrid: document.getElementById('rewardsGrid'),
        redeemModal: document.getElementById('redeemModal'),
        redeemModalImage: document.getElementById('redeemModalImage'),
        redeemModalTitle: document.getElementById('redeemModalTitle'),
        redeemModalPoints: document.getElementById('redeemModalPoints'),
        redeemModalCloseBtn: document.getElementById('redeemModalCloseBtn'),
        redeemModalConfirmBtn: document.getElementById('redeemModalConfirmBtn'), 
        redeemStatus: document.getElementById('redeemStatus'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingText: document.getElementById('loadingText'),
        infoModal: document.getElementById('infoModal'),
        infoModalTitle: document.getElementById('infoModalTitle'),
        infoModalMessage: document.getElementById('infoModalMessage'),
        infoModalCloseBtn: document.getElementById('infoModalCloseBtn'),
        rewardButtons: document.querySelectorAll('.reward-button') // Select all reward buttons
    };

    // --- Configuration ---
    const SHEETDB_API_ID = "5ss66fnmfz8vl"; // IMPORTANT: Replace with your SheetDB API ID
    
    // --- State ---
    let state = {
        currentUserCode: null,
        currentPoints: 0,
        // inventory will now store quantities with data-reward-code as keys
        // e.g., { Reward1: 15, Reward2: 5, ... }
        inventory: {}, 
        isRedeeming: false,
        isDataLoaded: false,
    };

    // --- UI Update Functions ---
    
    function showLoading(isLoading, text = "Loading Data...") { 
        dom.loadingText.textContent = text;
        dom.loadingOverlay.classList.toggle('visible', isLoading); 
    }
    
    /**
     * Updates the entire UI based on the current state (points and inventory).
     * Disables buttons and sets appropriate overlay messages.
     */
    function updateRewardsUI() {
        if (!state.isDataLoaded) return; // Don't update UI until all data is fetched

        dom.userPoints.textContent = state.currentPoints;
        
        dom.rewardButtons.forEach(button => {
            const cost = parseInt(button.dataset.cost, 10);
            const rewardCode = button.dataset.rewardCode; // This is 'Reward1', 'Reward2', etc.
            // Get quantity from state.inventory using the rewardCode
            const quantity = state.inventory[rewardCode] ?? 0; // Use ?? for modern nullish coalescing

            const quantityValueEl = button.querySelector('.quantity-value');
            if (quantityValueEl) {
                quantityValueEl.textContent = quantity; // Update the displayed quantity
            }

            const disabledOverlay = button.querySelector('.disabled-overlay');
            
            // Determine if the button should be disabled
            if (quantity <= 0) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Out of Stock";
            } else if (state.currentPoints < cost) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Not enough<br>points";
            } else {
                button.disabled = false; // Enable if sufficient points and in stock
            }
        });
    }

    // --- Modal Functions ---

    function showRedeemModal(rewardButton) {
        const { label, cost, rewardCode } = rewardButton.dataset;
        const imgSrc = rewardButton.querySelector('img').src;
        
        dom.redeemModalImage.src = imgSrc;
        dom.redeemModalTitle.textContent = label;
        dom.redeemModalPoints.textContent = cost;
        dom.redeemStatus.classList.add('hidden');
        dom.redeemModal.classList.add('visible');
        
        dom.redeemModalConfirmBtn.onclick = () => redeemReward(rewardCode, parseInt(cost, 10));
    }

    function closeRedeemModal() { 
        dom.redeemModal.classList.remove('visible'); 
        dom.redeemModalConfirmBtn.onclick = null; 
    }

    function showInfoModal(title, message, onOk) {
        // Add null checks before attempting to access properties of DOM elements
        if (dom.infoModalTitle) {
            dom.infoModalTitle.textContent = title;
        } else {
            console.error("Error: infoModalTitle element not found in DOM for showInfoModal.");
        }
        
        if (dom.infoModalMessage) {
            dom.infoModalMessage.textContent = message;
        } else {
            console.error("Error: infoModalMessage element not found in DOM for showInfoModal.");
        }
        
        if (dom.infoModal) {
            dom.infoModal.classList.add('visible');
        } else {
            console.error("Error: infoModal element not found in DOM for showInfoModal.");
        }

        const close = () => { 
            if (dom.infoModal) {
                dom.infoModal.classList.remove('visible'); 
            } else {
                console.error("Error: infoModal element not found during close action.");
            }
            if (dom.infoModalCloseBtn) {
                dom.infoModalCloseBtn.onclick = null;
            } else {
                console.error("Error: infoModalCloseBtn element not found during close action.");
            }
            if (onOk) onOk();
        };
        
        if (dom.infoModalCloseBtn) {
            dom.infoModalCloseBtn.onclick = close;
        } else {
            console.error("Error: infoModalCloseBtn element not found for setting click handler.");
        }
    }

    // --- API & Data Functions ---

    /**
     * Fetches user data from the SheetDB API.
     */
    async function fetchUserData(code) {
        const url = `https://sheetdb.io/api/v1/${SHEETDB_API_ID}/search?sheet=Users&Access%20Code=${encodeURIComponent(code)}&casesensitive=false`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Network error fetching user data: ${res.statusText}`);
        
        const data = await res.json();
        if (!data || data.length === 0) throw new Error("Access code not found.");
        
        state.currentPoints = parseInt(data[0].Points || "0", 10);
    }
    
    /**
     * NEW & FIXED: Fetches inventory data from the SheetDB API (Sheet3 "Inventory").
     * This function now correctly maps "Prize" names from the sheet to the
     * data-reward-code values used in the HTML buttons.
     */
    async function fetchInventoryData() {
        const url = `https://sheetdb.io/api/v1/${SHEETDB_API_ID}?sheet=Inventory`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Network error fetching inventory: ${res.statusText}`);
        
        const rawInventoryData = await res.json();
        console.log("Raw Inventory Data from SheetDB:", rawInventoryData); 
        if (rawInventoryData.length > 0) {
            console.log("Keys available in first inventory item:", Object.keys(rawInventoryData[0]));
        }

        // Create a temporary map for quick lookup: Prize Name -> Quantity
        const prizeNameToQuantityMap = rawInventoryData.reduce((acc, item) => {
            const prizeName = item["Prize"]; // This is "Candy", "Cookie", etc.
            const quantity = item["Remaining Qty"]; // This is the numerical quantity

            if (prizeName) {
                acc[prizeName] = parseInt(quantity || "0", 10);
            }
            return acc;
        }, {});
        console.log("Temporary Prize Name -> Quantity Map:", prizeNameToQuantityMap);

        // Now, populate state.inventory using the HTML button's data-reward-code as the key
        // and looking up the quantity via the data-label (which matches the Prize Name)
        state.inventory = {}; // Reset inventory
        dom.rewardButtons.forEach(button => {
            const rewardCode = button.dataset.rewardCode; // e.g., 'Reward1'
            const prizeLabel = button.dataset.label;     // e.g., 'Candy'

            // Look up the quantity using the prizeLabel from the temporary map
            const quantityForReward = prizeNameToQuantityMap[prizeLabel] ?? 0;
            state.inventory[rewardCode] = quantityForReward;
        });
        
        console.log("Processed Inventory State (using data-reward-code as keys):", state.inventory);
    }

    /**
     * Handles the reward redemption process with optimistic UI updates.
     */
    async function redeemReward(rewardCode, cost) {
        if (state.isRedeeming) return;

        state.isRedeeming = true;
        dom.redeemModalConfirmBtn.disabled = true;
        dom.redeemModalConfirmBtn.textContent = 'Redeeming...';

        const originalPoints = state.currentPoints;
        // Make a deep copy of inventory to easily rollback
        const originalInventory = JSON.parse(JSON.stringify(state.inventory)); 

        // 1. Optimistic UI Update: Deduct points and quantity immediately
        state.currentPoints -= cost;
        if (state.inventory[rewardCode] !== undefined) {
            state.inventory[rewardCode]--;
        }
        updateRewardsUI(); // Update UI with new optimistic values

        const payload = {
            sheet: "History", // Target Sheet2 "History"
            data: [{
                "Access Code": state.currentUserCode, // A1 Access Code
                "Timestamp": new Date().toISOString(), // F1 Timestamp
                "Code": rewardCode // G1 Code ('Reward1', 'Reward2', etc.)
            }]
        };

        try {
            // 2. API Call: Send redemption record to SheetDB
            const response = await fetch(`https://sheetdb.io/api/v1/${SHEETDB_API_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorBody}`);
            }

            console.log('Redemption logged successfully:', await response.json());

            // 3. Success Feedback
            dom.redeemStatus.textContent = 'Success! Reward redeemed.';
            dom.redeemStatus.className = 'font-semibold mt-2 text-green-600';
            dom.redeemStatus.classList.remove('hidden');

            setTimeout(() => {
                closeRedeemModal();
            }, 1500);

        } catch (error) {
            console.error('Redemption error:', error);
            
            // 5. Rollback UI on Failure
            state.currentPoints = originalPoints;
            state.inventory = originalInventory;
            updateRewardsUI(); // Revert UI to original state

            dom.redeemStatus.textContent = `Error: Could not redeem.`;
            dom.redeemStatus.className = 'font-semibold mt-2 text-red-500';
            dom.redeemStatus.classList.remove('hidden');
        } finally {
            // 6. Reset Modal State and re-sync with server after a delay
            setTimeout(() => {
                state.isRedeeming = false;
                dom.redeemModalConfirmBtn.disabled = false;
                dom.redeemModalConfirmBtn.textContent = 'Redeem Now';
                // Full re-sync to ensure data consistency after optimistic update/rollback
                fetchAllData(); 
            }, 2000);
        }
    }

    /**
     * Main data fetching and initialization function
     */
    async function fetchAllData() {
        showLoading(true);
        try {
            // Fetch user points and inventory in parallel for speed
            await Promise.all([
                fetchUserData(state.currentUserCode),
                fetchInventoryData() // This now handles the mapping logic
            ]);
            state.isDataLoaded = true;
            updateRewardsUI(); // Update UI after all data is loaded and processed
        } catch (error) {
             console.error("Failed to load initial data:", error);
            showInfoModal("Error", `Could not load page data. Please try again or log in. (Details: ${error.message})`, () => {
                window.location.href = 'index.html';
            });
        } finally {
            showLoading(false);
        }
    }
    
    // --- Initialization ---
    
    function initialize() {
        state.currentUserCode = sessionStorage.getItem('currentUserCode');
        if (!state.currentUserCode) {
            showInfoModal("Session Expired", "No active user session found. Please log in to continue.", () => {
                window.location.href = 'index.html';
            });
            return;
        }

        fetchAllData(); // Start fetching all necessary data

        // Event Listeners for reward buttons
        dom.rewardsGrid.addEventListener('click', (e) => {
            const rewardButton = e.target.closest('.reward-button');
            if (rewardButton && !rewardButton.disabled) {
                showRedeemModal(rewardButton);
            }
        });

        // Event Listeners for modals
        dom.redeemModalCloseBtn.addEventListener('click', closeRedeemModal);
        dom.redeemModal.addEventListener('click', (e) => {
            if (e.target === dom.redeemModal) closeRedeemModal();
        });
        dom.infoModalCloseBtn.addEventListener('click', () => showInfoModal('Info', 'Operation complete.', null)); // Generic close for info modal
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
