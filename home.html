<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Starlight Dashboard</title>

    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#F5F7F6"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Starlight">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font is unified to "Inter" for design consistency -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- UNIFIED Color Palette & Font --- */
        :root {
            /* Core Palette */
            --background: #F5F7F6;
            --card-bg: #F3F8F4;
            --card-border: #E1E5E3;
            --primary-accent: #89B3D9;
            --cta-accent: #F4D35E;
            --text-title: #2D3748;
            --text-body: #5F7D97;
            --text-on-cta: #1C2B26;

            /* Tier Colors */
            --tier1-green-bg: #E6F3E9;
            --tier1-green-border: #C8E2D0;
            --tier1-green-icon: #2A745C;
            
            --tier2-blue-bg: #D9E8F1;
            --tier2-blue-border: #BFD7E5;
            --tier2-blue-icon: #326E9B;

            --tier3-yellow-bg: #FFF4D6;
            --tier3-yellow-border: #FFE8AC;
            --tier3-yellow-icon: #B58700;
            
            /* Sizing variables */
            --base-font-size: 16px;
            --base-padding: 1.5rem;
            --base-gap: 1.5rem;
        }

        /* --- Base Styles --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* Prevent body scroll */
            background-color: var(--background);
            font-family: 'Inter', sans-serif; 
            color: var(--text-body);
            font-size: var(--base-font-size);
        }
        
        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #E0EBEA; }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); opacity: 0.7; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); opacity: 1; }
        
        /* --- Overlays and Modals (Unified) --- */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease-out, visibility 0s 0.3s;
            background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px);
            visibility: hidden;
        }
        .fullscreen-overlay.visible { 
            display: flex; opacity: 1; visibility: visible; 
            transition: opacity 0.3s ease-out;
        }
        
        .popup-card {
            background-color: var(--card-bg); border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); display: flex;
            flex-direction: column; width: 90%; max-width: 400px; max-height: 90vh;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .fullscreen-overlay.visible .popup-card { transform: scale(1); opacity: 1; }
        
        /* --- Dashboard Container --- */
        #dashboard {
            display: none; /* Hidden by default */
            height: 100dvh;
            padding: var(--base-padding);
            opacity: 0; transition: opacity 0.5s ease-in;
            flex-direction: column; /* Main layout is vertical */
            box-sizing: border-box;
            max-width: 2000px; 
            margin: 0 auto; 
        }
        
        .dashboard-card {
            background-color: var(--card-bg); 
            border-radius: 1.5rem;
            border: 1px solid var(--card-border); 
            padding: var(--base-padding);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            box-sizing: border-box;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        /* --- Interactive Card (Game Button) --- */
        .interactive-card {
            background-color: var(--card-bg); 
            border: 1px solid var(--card-border); 
            border-radius: 1rem;
            transition: all 0.2s ease-out; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-decoration: none;
            padding: 0.5rem;
            min-width: 120px;
        }
        .interactive-card:hover {
            transform: translateY(-4px); 
            border-color: var(--primary-accent);
            box-shadow: 0 6px 15px -5px rgba(0,0,0,0.1);
        }

        /* --- NEW: Reward Button Styles (from rewards.html, adapted) --- */
        .reward-button {
            background-color: white; /* Use white for rewards to stand out slightly */
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            transition: all 0.2s ease-out;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(0.75rem, 3vw, 1rem); /* Responsive padding */
            aspect-ratio: 1 / 1; /* Maintain square shape */
        }
        .reward-button:hover:not(:disabled) { 
            transform: translateY(-4px); 
            border-color: var(--primary-accent);
            box-shadow: 0 8px 20px -5px rgba(137, 179, 217, 0.3); 
        }
        .reward-button:disabled { 
            cursor: not-allowed; 
            background-color: var(--background); /* Match page background */
        }
        /* Content inside the button */
        .reward-button img {
            width: clamp(3rem, 15vw, 4rem);
            height: clamp(3rem, 15vw, 4rem);
            object-fit: cover;
            border-radius: 0.75rem;
        }
        .reward-button .label {
            margin-top: 0.5rem;
            font-weight: 600;
            color: var(--text-title);
            font-size: clamp(0.85rem, 3vw, 1rem);
            text-align: center;
        }
        .reward-button .points {
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            font-weight: 700;
            color: var(--primary-accent); /* Use consistent accent color */
        }
        .reward-button .quantity {
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            font-weight: 500;
            color: var(--text-body);
            margin-top: 2px;
        }

        /* Disabled State Overlay */
        .reward-button .disabled-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(243, 248, 244, 0.7); /* Use var(--card-bg) with opacity */
            backdrop-filter: grayscale(80%) blur(1px);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: var(--text-body);
            opacity: 0;
            transition: opacity 0.2s ease-out;
            pointer-events: none;
            font-size: 0.9rem;
            padding: 0.25rem;
        }
        .reward-button:disabled .disabled-overlay {
            opacity: 1;
        }

        /* --- Responsive Design --- */
        /* Mobile */
        @media (max-width: 767px) {
            :root {
                --base-font-size: 14px;
                --base-padding: 1rem;
                --base-gap: 1rem;
            }
            /* On mobile, the main grid is just a flex-col */
            .main-grid {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                gap: var(--base-gap);
                overflow: hidden;
            }
            .history-card, .rewards-card {
                min-height: 300px; /* Give history/rewards a min height on mobile */
            }
            /* Mobile rewards grid */
            #rewardsGrid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }

        /* Tablet & Desktop */
        @media (min-width: 768px) {
            /* On desktop, switch to a 3-column grid */
            .main-grid {
                flex-grow: 1;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: var(--base-gap);
                overflow: hidden; /* This is important for child scroll */
            }
            /* Desktop rewards grid */
            #rewardsGrid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        /* Large Desktop Optimization */
        @media (min-width: 1920px) {
            :root {
                --base-font-size: 18px;
                --base-padding: 2.5rem;
                --base-gap: 2.5rem;
            }
            .dashboard-card header { font-size: 3.5rem; }
            #rewardsGrid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* --- Modal Buttons (Unified) --- */
        .modal-button { 
            flex-grow: 1; 
            text-align: center; 
            padding: 1rem; 
            font-weight: 600; 
            border-radius: 0.75rem; 
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .modal-button.primary { 
            background-color: var(--cta-accent); 
            color: var(--text-on-cta); 
            box-shadow: 0 4px 8px rgba(244, 211, 94, 0.3);
        }
        .modal-button.primary:hover:not(:disabled) { 
            opacity: 0.9; 
        }
        .modal-button.primary:disabled { 
            background: #94A3B8; 
            opacity: 0.7; 
            cursor: wait; 
        }

    </style>
</head>
<body class="antialiased">
    
    <!-- NEW: Loading Overlay (from rewards.html) -->
    <div id="loadingOverlay" class="fullscreen-overlay !bg-white/80 z-[110]">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="color: var(--primary-accent);"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loadingText" class="mt-4 font-semibold" style="color: var(--text-body);">Loading Data...</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main id="dashboard" class="flex">
        
        <!-- Row 1: Title & Logout Button -->
        <div class="flex-shrink-0 flex justify-between items-center">
             <header class="font-bold text-4xl md:text-5xl" style="color: var(--text-title);">Starlight Dashboard</header>
             <button id="logoutButton" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-body);">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
             </button>
        </div>
        
        <!-- Row 2: Main 3-Column Grid -->
        <div class="main-grid mt-4 md:mt-6">
            
            <!-- Column 1: User & Game -->
            <div class="flex flex-col gap-6">
                <!-- User Card (Pass + Welcome) -->
                <div class="dashboard-card flex-grow flex flex-col justify-center text-center p-6 gap-2">
                    <!-- Pass/Tier data -->
                    <p id="userTier" class="text-4xl font-bold" style="color: var(--text-title);">Loading...</p>
                    <!-- Welcome message -->
                    <p id="userName" class="text-xl md:text-2xl">Welcome, <span class="font-semibold" style="color: var(--text-title);">...</span></p>
                </div>
                
                <!-- Game Card -->
                <div class="dashboard-card flex flex-col">
                    <h3 class="font-bold text-xl text-center mb-4 flex-shrink-0" style="color: var(--text-title);">Ready to Play?</h3>
                    <div class="text-sm space-y-3 px-2 flex-shrink-0">
                        <p>üéµ Listen to the K-Pop instrumental and guess the song!</p>
                        <p>‚è±Ô∏è Think fast! You'll have <strong>10 seconds</strong> to name that tune.</p>
                        <p>üèÜ Every correct answer earns you <strong>1 point</strong> to spend on cool rewards!</p>
                    </div>
                    <div class="flex-grow flex items-center justify-center pt-6">
                        <a href="game2.html" class="interactive-card" data-label="Guess the Song (Moderate)"><div class="h-10 w-10 md:h-12 md:w-12 text-purple-500 mx-auto card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.59 14.37a6 6 0 01-5.64 2.13a6 6 0 01-1.1-11.95a6 6 0 018.66 8.66L19 18zM10 16a6 6 0 100-12a6 6 0 000 12z" clip-rule="evenodd" /></svg></div><span class="card-title block font-semibold mt-2 text-xs md:text-base" style="color: var(--text-title);">Guess the Song</span><span class="card-subtitle block text-xs md:text-sm font-medium">Moderate</span></a>
                    </div>
                </div>
            </div>

            <!-- Column 2: Points & History -->
            <div class="dashboard-card flex flex-col overflow-hidden history-card">
                <!-- Top Section: Points -->
                <div class="flex-shrink-0">
                    <div class="flex justify-between items-center" style="border-color: var(--card-border);">
                        <div class="flex items-center gap-2 md:gap-3">
                            <span class="font-semibold text-base md:text-lg">Points:</span>
                            <span id="userPoints" class="text-3xl md:text-4xl font-bold" style="color: var(--text-title);">0</span>
                        </div>
                        <!-- NOTE: "Rewards" button removed as it's now a column -->
                    </div>
                </div>
                <!-- History Section Title -->
                <div class="flex-shrink-0 flex justify-between items-center mt-6 pt-4 border-t" style="border-color: var(--card-border);">
                     <h3 class="text-lg font-bold" style="color: var(--text-title);">Points History</h3>
                     <button id="refreshHistoryBtn" class="p-1 rounded-full hover:bg-slate-100"><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M2 12.08c-.006-.862.91-1.356 1.618-.975l.095.058 2.678 1.804c.972.655.377 2.143-.734 2.007l-.117-.02-1.063-.234a8.002 8.002 0 0 0 14.804.605 1 1 0 0 1 1.82.828c-1.987 4.37-6.896 6.793-11.687 5.509A10.003 10.003 0 0 1 2 12.08Zm.903-4.228C4.89 3.482 9.799 1.06 14.59 2.343a10.002 10.002 0 0 1 7.414 9.581c.007.863-.91 1.358-1.617.976l-.096-.058-2.678-1.804c-.972-.655-.377-2.143.734-2.007l.117.02 1.063.234A8.002 8.002 0 0 0 4.723 8.68a1 1 0 1 1-1.82-.828Z" fill="currentColor"/></g></svg></button>
                </div>
                <!-- Scrollable List -->
                <div id="historyList" class="flex-grow overflow-y-auto pt-2">
                    <!-- History items will be injected here by JS -->
                </div>
            </div>

            <!-- Column 3: Rewards (from rewards.html) -->
            <div class="dashboard-card flex flex-col overflow-hidden rewards-card">
                <h3 class="text-lg font-bold flex-shrink-0" style="color: var(--text-title);">Redeem Rewards</h3>
                <main id="rewardsGrid" class="flex-grow overflow-y-auto pt-4 grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <!-- Reward buttons will be dynamically checked by JS -->
                    <button class="reward-button" data-cost="5" data-label="Candy" data-reward-code="Reward1">
                        <img src="https://placehold.co/128x128/FEF2F2/DC2626?text=ÓÅûÊ∑∑" alt="Candy Icon" class="bg-red-100">
                        <p class="label">Candy</p>
                        <p class="points">5 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="15" data-label="Cookie" data-reward-code="Reward2">
                        <img src="https://placehold.co/128x128/FFFBEB/D97706?text=ÓÅûÊ†π" alt="Cookie Icon" class="bg-amber-100">
                        <p class="label">Cookie</p>
                        <p class="points">15 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="45" data-label="Ramen" data-reward-code="Reward3">
                        <img src="https://placehold.co/128x128/FFF7ED/F97316?text=ÓÅûÈ™®" alt="Ramen Icon" class="bg-orange-100">
                        <p class="label">Ramen</p>
                        <p class="points">45 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="75" data-label="Photocard" data-reward-code="Reward4">
                        <img src="https://placehold.co/128x128/F0F9FF/0284C7?text=ÓÅûËêÑ" alt="Photocard Icon" class="bg-sky-100">
                        <p class="label">Photocard</p>
                        <p class="points">75 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                </main>
            </div>

        </div>
    </main>
    
    <!-- MODALS (Merged) -->
    
    <!-- General Info Modal (for errors, logout) -->
    <div id="infoModal" class="fullscreen-overlay">
        <div class="popup-card p-6 gap-4 text-center">
            <h3 id="infoModalTitle" class="text-2xl font-bold" style="color: var(--text-title);"></h3>
            <p id="infoModalMessage" class="text-slate-500 break-words"></p>
            <div class="flex items-center justify-center gap-4 mt-4 w-full">
                <!-- NEW: Cancel button for confirmation dialogs -->
                <button id="infoModalCancelBtn" class="modal-button primary !bg-slate-200 !text-slate-700" style="display: none;">Cancel</button>
                <button id="infoModalCloseBtn" class="modal-button primary w-full">OK</button>
            </div>
        </div>
    </div>

    <!-- Redeem Confirmation Modal (from rewards.html) -->
    <div id="redeemModal" class="fullscreen-overlay">
        <div class="popup-card p-6 gap-4 text-center">
            <button id="redeemModalCloseBtn" class="absolute top-3 right-3 p-1 rounded-full hover:bg-slate-100" style="color: var(--text-body);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <img id="redeemModalImage" src="" alt="Reward Image" class="w-32 h-32 md:w-40 md:h-40 object-cover rounded-xl mx-auto">
            <h3 id="redeemModalTitle" class="text-2xl font-bold" style="color: var(--text-title);"></h3>
            <p>Redeem this reward for <strong id="redeemModalPoints" style="color: var(--text-title);"></strong> points?</p>
            <div id="redeemStatus" class="font-semibold mt-2 hidden h-6"></div>
            <div class="flex items-center justify-center gap-4 mt-2 w-full">
                <button id="redeemModalConfirmBtn" class="modal-button primary w-full">Redeem Now</button>
            </div>
        </div>
    </div>
    
  <script>
    // --- DOM Element Store ---
    // Select all DOM elements once on load
    const dom = {}; 

    // --- App Configuration ---
    // GET requests (fetch data) MUST use Google Apps Script
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx4gnu4M58111FVS9gDEHvurXZXp9PthE2e6PyACUpBRJk8adG_L4oK7EuG6nOsbflN/exec"; // IMPORTANT: Replace this
    
    // POST requests (submit data) MUST use SheetDB
    const SHEETDB_POST_API_ID = "5ss66fnmfz8vl"; // IMPORTANT: Replace with your SheetDB API ID

    // --- App State ---
    const state = {
        currentUserCode: null,
        currentPoints: 0,
        inventory: {}, // e.g., { Reward1: 15, Reward2: 5, ... }
        isRedeeming: false,
        isDataLoaded: false,
    };

    // --- UI Flow & Data Functions ---

    function showLoading(isLoading, text = "Loading Data...") { 
        if (dom.loadingText) dom.loadingText.textContent = text;
        if (dom.loadingOverlay) dom.loadingOverlay.classList.toggle('visible', isLoading); 
    }

    function redirectToLogin() {
        sessionStorage.removeItem('currentUserCode');
        window.location.href = 'index.html';
    }

    /**
     * Shows a modal. Can be a simple "OK" modal or a "Confirm/Cancel" modal.
     * @param {string} title - The title of the modal.
     * @param {string} message - The message content.
     * @param {function} [onOk] - Optional function to run when OK/Confirm is clicked.
     * @param {boolean} [showCancel=false] - If true, shows a Cancel button.
     */
    function showInfoModal(title, message, onOk, showCancel = false) {
        dom.infoModalTitle.textContent = title;
        dom.infoModalMessage.textContent = message;

        if (showCancel) {
            dom.infoModalCancelBtn.style.display = 'block';
            dom.infoModalCloseBtn.textContent = 'Confirm';
        } else {
            dom.infoModalCancelBtn.style.display = 'none';
            dom.infoModalCloseBtn.textContent = 'OK';
        }

        dom.infoModal.classList.add('visible');

        const close = () => { 
            dom.infoModal.classList.remove('visible'); 
            dom.infoModalCloseBtn.onclick = null;
            dom.infoModalCancelBtn.onclick = null;
        };

        dom.infoModalCloseBtn.onclick = () => {
            close();
            if (onOk) onOk();
        };
        
        dom.infoModalCancelBtn.onclick = close; // Cancel just closes the modal
    }

    // --- Data Fetching (GET from Google Apps Script) ---
    async function fetchHomePageData(code, isManualRefresh = false) {
      if (isManualRefresh) {
        dom.refreshHistoryBtn?.classList.add('animate-spin');
      }
      if (!state.isDataLoaded) { // Only show full loading screen on first load
        showLoading(true);
      }
    
      try {
        // NEW: This action fetches ALL data (user, history, inventory)
        const url = `${GAS_WEB_APP_URL}?action=getHomePageData&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);

        if (!res.ok) throw new Error(`Data refresh failed: ${res.status}`);
        
        const result = await res.json();

        if (result.status !== 'success') {
            throw new Error(result.message || "Invalid user data.");
        }
        
        // --- Process ALL data from the single response ---
        
        // 1. Update User Info & Points
        state.currentPoints = parseInt(result.user?.Points || "0", 10);
        updateUserCard(result.user); // Update welcome/tier card
        dom.userPoints.textContent = state.currentPoints; // Update points in history column

        // 2. Render History
        renderHistoryList(result.history || []);

        // 3. Process Inventory & Update Rewards
        const rawInventoryData = result.inventory || [];
        const prizeNameToQuantityMap = rawInventoryData.reduce((acc, item) => {
            const prizeName = item["Prize"];
            const quantity = item["Remaining Qty"];
            if (prizeName) {
                acc[prizeName] = parseInt(quantity || "0", 10);
            }
            return acc;
        }, {});

        state.inventory = {}; // Reset inventory
        dom.rewardButtons.forEach(button => {
            const rewardCode = button.dataset.rewardCode;
            const prizeLabel = button.dataset.label;
            state.inventory[rewardCode] = prizeNameToQuantityMap[prizeLabel] ?? 0;
        });

        state.isDataLoaded = true;
        updateRewardsUI(); // Update reward buttons (enable/disable)

      } catch (error) {
        console.error("Failed to fetch dashboard data:", error);
        showInfoModal("Data Error", `Failed to load dashboard data: ${error.message}. Returning to login.`, () => {
            redirectToLogin();
        });
      } finally {
        if (isManualRefresh) {
            dom.refreshHistoryBtn?.classList.remove('animate-spin');
        }
        showLoading(false); // Hide loading overlay
      }
    }

    // --- UI Rendering Functions ---

    /**
     * Updates the User Card with Tier and Welcome Message
     */
    function updateUserCard(userData) {
        const tier = userData?.Event1 ? String(userData.Event1) : 'Ticket Pending';
        const tierName = tier.charAt(0).toUpperCase() + tier.slice(1);
        
        let iconColor = 'var(--text-body)';
        if (tier.includes('economy')) iconColor = 'var(--tier1-green-icon)';
        else if (tier.includes('business')) iconColor = 'var(--tier2-blue-icon)';
        else if (tier.includes('first')) iconColor = 'var(--tier3-yellow-icon)';

        dom.userTier.textContent = tierName;
        dom.userTier.style.color = iconColor;
        dom.userName.querySelector('span').textContent = `${userData?.Name || "Guest"}!`;
    }

    /**
     * Renders the scrollable history list
     */
    function renderHistoryList(historyData) {
        if (!historyData || historyData.length === 0) {
            dom.historyList.innerHTML = `<p class="text-center py-8">No points history recorded.</p>`;
            return;
        }
        dom.historyList.innerHTML = ''; 
        const container = document.createElement('div');
        container.className = 'w-full text-sm flex flex-col space-y-2';
        historyData.forEach(item => {
            const points = parseInt(item.Points, 10) || 0;
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center py-3 border-b';
            row.style.borderColor = 'var(--card-border)';
            row.innerHTML = `
                <span class="font-semibold text-left" style="color: var(--text-title);">${item.Transaction || 'Event'}</span>
                <span class="font-bold text-lg text-right ${points >= 0 ? 'text-green-600' : 'text-red-500'}">${points >= 0 ? '+' : ''}${points}</span>
            `;
            container.appendChild(row);
        });
        dom.historyList.appendChild(container);
    }

    /**
     * Updates Reward Buttons (from rewards.html)
     * Disables buttons based on points and inventory.
     */
    function updateRewardsUI() {
        if (!state.isDataLoaded) return; 

        dom.rewardButtons.forEach(button => {
            const cost = parseInt(button.dataset.cost, 10);
            const rewardCode = button.dataset.rewardCode;
            const quantity = state.inventory[rewardCode] ?? 0;
            const quantityValueEl = button.querySelector('.quantity-value');
            if (quantityValueEl) quantityValueEl.textContent = quantity;

            const disabledOverlay = button.querySelector('.disabled-overlay');
            
            if (quantity <= 0) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Out of Stock";
            } else if (state.currentPoints < cost) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Not enough<br>points";
            } else {
                button.disabled = false;
            }
        });
    }

    // --- Reward Redemption Functions (from rewards.html) ---

    function showRedeemModal(rewardButton) {
        const { label, cost, rewardCode } = rewardButton.dataset;
        const imgSrc = rewardButton.querySelector('img').src;
        
        dom.redeemModalImage.src = imgSrc;
        dom.redeemModalTitle.textContent = label;
        dom.redeemModalPoints.textContent = cost;
        dom.redeemStatus.classList.add('hidden');
        dom.redeemModal.classList.add('visible');
        
        dom.redeemModalConfirmBtn.onclick = () => redeemReward(rewardCode, parseInt(cost, 10));
    }

    function closeRedeemModal() { 
        dom.redeemModal.classList.remove('visible'); 
        dom.redeemModalConfirmBtn.onclick = null; 
    }

    /**
     * Handles the reward redemption (POST to SheetDB)
     */
    async function redeemReward(rewardCode, cost) {
        if (state.isRedeeming) return;
        state.isRedeeming = true;

        dom.redeemModalConfirmBtn.disabled = true;
        dom.redeemModalConfirmBtn.textContent = 'Redeeming...';

        // Optimistic UI Update: Deduct points and quantity
        const originalPoints = state.currentPoints;
        const originalInventory = JSON.parse(JSON.stringify(state.inventory)); 
        state.currentPoints -= cost;
        if (state.inventory[rewardCode] !== undefined) {
            state.inventory[rewardCode]--;
        }
        updateRewardsUI(); // Update rewards
        dom.userPoints.textContent = state.currentPoints; // Update main points display

        // This payload POSTS to SheetDB
        const correctedPayload = {
            sheet: "History", // Target "History" sheet
            data: [{
                "Access Code": state.currentUserCode,
                "Transaction": `Redeemed ${rewardCode}`, // E: Transaction
                "Points": -cost, // F: Points
                "Timestamp": new Date().toISOString() // G: Timestamp
            }]
        };

        try {
            const response = await fetch(`https://sheetdb.io/api/v1/${SHEETDB_POST_API_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(correctedPayload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            // Success
            dom.redeemStatus.textContent = 'Success! Reward redeemed.';
            dom.redeemStatus.className = 'font-semibold mt-2 text-green-600';
            dom.redeemStatus.classList.remove('hidden');

            setTimeout(() => { closeRedeemModal(); }, 1500);

        } catch (error) {
            console.error('Redemption error:', error);
            
            // Rollback UI on Failure
            state.currentPoints = originalPoints;
            state.inventory = originalInventory;
            updateRewardsUI();
            dom.userPoints.textContent = state.currentPoints;

            dom.redeemStatus.textContent = `Error: Could not redeem.`;
            dom.redeemStatus.className = 'font-semibold mt-2 text-red-500';
            dom.redeemStatus.classList.remove('hidden');

        } finally {
            // Re-sync with server after a delay, regardless of outcome
            setTimeout(() => {
                state.isRedeeming = false;
                dom.redeemModalConfirmBtn.disabled = false;
                dom.redeemModalConfirmBtn.textContent = 'Redeem Now';
                fetchHomePageData(state.currentUserCode, true); // Re-fetch ALL data
            }, 2000);
        }
    }

    
    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Assign all DOM elements ---
        dom.dashboard = document.getElementById('dashboard');
        dom.userName = document.getElementById('userName');
        dom.userTier = document.getElementById('userTier');
        dom.userPoints = document.getElementById('userPoints');
        dom.historyList = document.getElementById('historyList');
        dom.refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        dom.logoutButton = document.getElementById('logoutButton');
        
        // Modals
        dom.infoModal = document.getElementById('infoModal');
        dom.infoModalTitle = document.getElementById('infoModalTitle');
        dom.infoModalMessage = document.getElementById('infoModalMessage');
        dom.infoModalCloseBtn = document.getElementById('infoModalCloseBtn');
        dom.infoModalCancelBtn = document.getElementById('infoModalCancelBtn');
        dom.loadingOverlay = document.getElementById('loadingOverlay');
        dom.loadingText = document.getElementById('loadingText');
        
        // Rewards (Merged)
        dom.rewardsGrid = document.getElementById('rewardsGrid');
        dom.rewardButtons = document.querySelectorAll('.reward-button');
        dom.redeemModal = document.getElementById('redeemModal');
        dom.redeemModalImage = document.getElementById('redeemModalImage');
        dom.redeemModalTitle = document.getElementById('redeemModalTitle');
        dom.redeemModalPoints = document.getElementById('redeemModalPoints');
        dom.redeemModalCloseBtn = document.getElementById('redeemModalCloseBtn');
        dom.redeemModalConfirmBtn = document.getElementById('redeemModalConfirmBtn'); 
        dom.redeemStatus = document.getElementById('redeemStatus');

        // --- 2. Check User Session ---
        state.currentUserCode = sessionStorage.getItem('currentUserCode');
        if (!state.currentUserCode) {
            redirectToLogin();
            return;
        }

        // --- 3. Show Dashboard & Fetch Data ---
        dom.dashboard.style.display = 'flex';
        setTimeout(() => { dom.dashboard.style.opacity = 1; }, 50);
        
        fetchHomePageData(state.currentUserCode); // Initial data fetch

        // --- 4. Add Event Listeners ---
        
        // Logout
        dom.logoutButton.addEventListener('click', () => {
            showInfoModal("Logout", "Are you sure you want to log out?", () => {
                redirectToLogin();
            }, true); // true = show cancel button
        });
      
        // Manual Refresh
        dom.refreshHistoryBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.currentUserCode) fetchHomePageData(state.currentUserCode, true);
        });

        // Reward Button Clicks
        dom.rewardsGrid.addEventListener('click', (e) => {
            const rewardButton = e.target.closest('.reward-button');
            if (rewardButton && !rewardButton.disabled) {
                showRedeemModal(rewardButton);
            }
        });

        // Redeem Modal Close Buttons
        dom.redeemModalCloseBtn.addEventListener('click', closeRedeemModal);
        dom.redeemModal.addEventListener('click', (e) => {
            if (e.target === dom.redeemModal) closeRedeemModal();
        });
    });
  </script>
</body>
</html>