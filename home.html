<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Starlight Dashboard</title>

    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#89B3D9"/> <!-- NEW: Changed to brand blue -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Starlight">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font is unified to "Inter" for design consistency -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- UNIFIED Color Palette & Font --- */
        :root {
            /* Core Palette */
            --background: #89B3D9; 
            --card-bg: #FFFFFF; /* "white" */
            --card-border: #E1E5E3;
            --primary-accent: #89B3D9; /* Brand Blue */
            --cta-accent: #F4D35E;
            --text-title: #2D3748;
            --text-body: #5F7D97;
            --text-on-cta: #1C2B26;

            /* Tier Colors */
            --tier1-green-bg: #E6F3E9;
            --tier1-green-border: #C8E2D0;
            --tier1-green-text: #2A745C;
            
            --tier2-blue-bg: #D9E8F1;
            --tier2-blue-border: #BFD7E5;
            --tier2-blue-text: #326E9B;

            --tier3-yellow-bg: #FFF4D6;
            --tier3-yellow-border: #FFE8AC;
            --tier3-yellow-text: #B58700;
            
            /* Sizing variables */
            --base-font-size: 16px;
            --base-padding: 1.5rem;
            --base-gap: 1.5rem;
        }

        /* --- Base Styles --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* Prevent body scroll */
            background-color: var(--primary-accent);
            background: linear-gradient(135deg, var(--primary-accent) 0%, #7aa8cc 100%);
            font-family: 'Inter', sans-serif; 
            color: var(--text-body);
            font-size: var(--base-font-size);
        }
        
        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #E0EBEA; }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); opacity: 0.7; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); opacity: 1; }
        
        /* --- Overlays and Modals (Unified) --- */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease-out, visibility 0s 0.3s;
            background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px);
            visibility: hidden;
        }
        .fullscreen-overlay.visible { 
            display: flex; opacity: 1; visibility: visible; 
            transition: opacity 0.3s ease-out;
        }
        
        .popup-card {
            background-color: var(--card-bg); border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); display: flex;
            flex-direction: column; width: 90%; max-width: 400px; max-height: 90vh;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .fullscreen-overlay.visible .popup-card { transform: scale(1); opacity: 1; }
        
        /* --- Dashboard Container --- */
        #dashboard {
            display: none; /* Hidden by default */
            height: 100dvh;
            padding: var(--base-padding);
            opacity: 0; transition: opacity 0.5s ease-in;
            flex-direction: column; /* Main layout is vertical */
            box-sizing: border-box;
            max-width: 2000px; 
            margin: 0 auto; 
        }
        
        /* --- Card Style --- */
        .dashboard-card {
            background-color: var(--card-bg); /* "white" */
            border-radius: 1.5rem;
            border: 1px solid var(--card-border); 
            box-shadow: 0 8px 16px rgba(45, 55, 72, 0.1), 0 4px 6px rgba(45, 55, 72, 0.05);
            box-sizing: border-box;
            transition: all 0.5s ease;
            overflow: hidden; /* Prevent content spill */
            padding: var(--base-padding);
        }

        /* --- Boarding Pass / Ticket Styles --- */
        .ticket-label {
            font-size: 0.75rem; /* 12px */
            font-weight: 600;
            color: var(--text-body);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .ticket-data {
            font-weight: 700;
            color: var(--text-title);
            margin-bottom: 0.75rem; /* 12px */
        }
        .ticket-stub {
            /* Mobile-first: top border */
            border-top: 2px dashed var(--card-border);
            padding-top: var(--base-padding);
        }

        /* --- Inner Pass Card Styles --- */
        #userPassCard {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            text-align: center;
            transition: all 0.5s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        /* Tier Colors */
        .tier-pending {
            background-color: #f0f0f0; border: 1px solid #ddd;
        }
        .tier-pending #userTier { color: #555; }
        .tier-economy {
            background-color: var(--tier1-green-bg);
            border: 1px solid var(--tier1-green-border);
        }
        .tier-economy #userTier { color: var(--tier1-green-text); }
        .tier-business {
            background-color: var(--tier2-blue-bg);
            border: 1px solid var(--tier2-blue-border);
        }
        .tier-business #userTier { color: var(--tier2-blue-text); }
        .tier-first {
            background-color: var(--tier3-yellow-bg);
            border: 1px solid var(--tier3-yellow-border);
        }
        .tier-first #userTier { color: var(--tier3-yellow-text); }


        /* --- Interactive Card (Game Button) --- */
        .interactive-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border); 
            border-radius: 1.5rem; 
            transition: all 0.2s ease-out; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-decoration: none;
            padding: 1.5rem; 
            width: 100%;
            max-width: 350px; 
            box-shadow: 0 8px 16px rgba(45, 55, 72, 0.1), 0 4px 6px rgba(45, 55, 72, 0.05);
        }
        .interactive-card:hover {
            transform: translateY(-4px) scale(1.02); 
            border-color: var(--primary-accent);
            box-shadow: 0 10px 25px -5px rgba(137, 179, 217, 0.3), 0 8px 10px -6px rgba(137, 179, 217, 0.2);
        }
        .interactive-card .card-icon svg {
             width: 3.5rem; 
             height: 3.5rem;
             color: var(--primary-accent); 
        }
        .interactive-card .card-title {
            font-size: 1.25rem; 
            margin-top: 1rem;
        }
        .interactive-card .card-subtitle {
             font-size: 1rem; 
        }


        /* --- Reward Button Styles --- */
        .reward-button {
            background-color: white; 
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            transition: all 0.2s ease-out;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(0.75rem, 3vw, 1rem); 
            aspect-ratio: 1 / 1; 
        }
        .reward-button:hover:not(:disabled) { 
            transform: translateY(-4px); 
            border-color: var(--primary-accent);
            box-shadow: 0 8px 20px -5px rgba(137, 179, 217, 0.3); 
        }
        .reward-button:disabled { 
            cursor: not-allowed; 
            background-color: rgba(255,255,255,0.7); 
        }
        .reward-button img {
            width: clamp(3rem, 15vw, 4rem);
            height: clamp(3rem, 15vw, 4rem);
            object-fit: cover;
            border-radius: 0.75rem;
        }
        .reward-button .label {
            margin-top: 0.5rem;
            font-weight: 600;
            color: var(--text-title);
            font-size: clamp(0.85rem, 3vw, 1rem);
            text-align: center;
        }
        .reward-button .points {
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            font-weight: 700;
            color: var(--primary-accent); 
        }
        .reward-button .quantity {
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            font-weight: 500;
            color: var(--text-body);
            margin-top: 2px;
        }

        /* Disabled State Overlay */
        .reward-button .disabled-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* White overlay */
            backdrop-filter: grayscale(80%) blur(1px);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: var(--text-body);
            opacity: 0;
            transition: opacity 0.2s ease-out;
            pointer-events: none;
            font-size: 0.9rem;
            padding: 0.25rem;
        }
        .reward-button:disabled .disabled-overlay {
            opacity: 1;
        }

        /* --- Responsive Design --- */
        /* Mobile */
        @media (max-width: 1023px) {
            :root {
                --base-font-size: 14px;
                --base-padding: 1rem;
                --base-gap: 1rem;
            }
            .main-grid {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                gap: var(--base-gap);
                overflow-y: auto; 
                padding-bottom: 2rem;
            }
            .history-card, .rewards-card, .game-card {
                min-height: 400px;
            }
            #rewardsGrid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .interactive-card {
                 padding: 1rem;
            }
             .interactive-card .card-icon svg {
                 width: 2.5rem; height: 2.5rem;
            }
            .interactive-card .card-title {
                font-size: 1.1rem;
            }

            /* On mobile, the wrapper just acts as a container */
            #grid-col-3-wrapper {
                display: flex;
                flex-direction: column;
                gap: var(--base-gap);
            }
            #grid-history {
                min-height: 400px; /* Keep the min-height */
            }
        }

        /* Tablet & Desktop: REDESIGNED 2-Column Grid */
        @media (min-width: 1024px) {
            .main-grid {
                flex-grow: 1;
                display: grid;
                /* MODIFIED: Changed to 2-column layout */
                grid-template-columns: 2fr 1fr; 
                grid-template-rows: auto 1fr; 
                gap: var(--base-gap);
                overflow: hidden; 
            }
            
            /* --- Grid cell placement --- */
            
            /* Top-Left: User Info (Pass + Welcome) */
            #grid-user-info {
                grid-column: 1 / 2;
                grid-row: 1 / 2;
                display: flex; 
                flex-direction: row; /* Horizontal layout */
                padding: 0; /* Remove padding for edge-to-edge content */
            }
            
            /* Ticket main/stub classes for desktop */
            .ticket-main {
                flex-grow: 1;
                padding: var(--base-padding);
            }
            .ticket-stub {
                flex-shrink: 0;
                width: 120px; 
                border-left: 2px dashed var(--card-border);
                border-top: none; /* Remove mobile border */
                padding: var(--base-padding);
                padding-top: var(--base-padding); /* Reset mobile padding */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            /* Rotated stub content */
            .ticket-stub-content {
                writing-mode: vertical-rl;
                transform: rotate(180deg);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--base-gap);
            }

            
            /* Top-Right: Game */
            #grid-game {
                /* MODIFIED: Moved to sidebar */
                grid-column: 2 / 3;
                grid-row: 1 / 2;
                display: flex; 
                flex-direction: column;
            }
            
            /* Bottom-Right: History Column Wrapper */
            #grid-col-3-wrapper {
                /* MODIFIED: Moved to sidebar, bottom */
                grid-column: 2 / 3;
                grid-row: 2 / 3; 
                display: flex;
                flex-direction: column;
                gap: var(--base-gap);
                overflow: hidden; /* To contain its children */
            }

            #grid-history {
                /* This is now a flex child, it should grow */
                flex-grow: 1;
                display: flex;
                flex-direction: column;
            }
            
            #logoutButton {
                /* This is the second flex child, it should not grow */
                flex-shrink: 0;
            }
            
            /* Bottom-Left: Rewards */
            #grid-rewards {
                /* MODIFIED: Moved to main column, bottom */
                grid-column: 1 / 2; 
                grid-row: 2 / 3;
                display: flex;
                flex-direction: column;
            }

            #rewardsGrid {
                grid-template-columns: repeat(4, 1fr);
                gap: 1rem;
            }
        }

        /* Large Desktop Optimization */
        @media (min-width: 1920px) {
            :root {
                --base-font-size: 18px;
                --base-padding: 2.5rem;
                --base-gap: 2.5rem;
            }
            #rewardsGrid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* --- Modal Buttons (Unified) --- */
        .modal-button { 
            flex-grow: 1; 
            text-align: center; 
            padding: 1rem; 
            font-weight: 600; 
            border-radius: 0.75rem; 
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .modal-button.primary { 
            background-color: var(--cta-accent); 
            color: var(--text-on-cta); 
            box-shadow: 0 4px 8px rgba(244, 211, 94, 0.3);
        }
        .modal-button.primary:hover:not(:disabled) { 
            opacity: 0.9; 
            transform: translateY(-2px);
        }
        .modal-button.primary:disabled { 
            background: #94A3B8; 
            opacity: 0.7; 
            cursor: wait; 
        }

    </style>
</head>
<body class="antialiased">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fullscreen-overlay !bg-white/80 z-[110]">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="color: var(--primary-accent);"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8
 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loadingText" class="mt-4 font-semibold" style="color: var(--text-body);">Loading Data...</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main id="dashboard" class="flex">
        
        <!-- Row 1: HEADER REMOVED -->
        
        <!-- Row 2: Main Grid (Redesigned) -->
        <div class="main-grid">
            
            <!-- Cell: Top-Left (User Info) -->
            <div id="grid-user-info" class="dashboard-card flex flex-col">
                
                <!-- Main ticket area -->
                <div class="ticket-main">
                    <!-- SVG logo -->
                    <div class="w-full max-w-[300px] mx-auto mb-4">
                        <!-- SVG code updated and fill color set -->
                        <svg id="Layer_2_Logo" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 84.16 37.41" class="h-auto w-full">
                            <defs>
                                <style>
                                    .cls-1 {
                                        fill: var(--primary-accent);
                                    }
                                </style>
                            </defs>
                            <g id="Layer_1-2" data-name="Layer 1">
                                <path class="cls-1" d="M9.75,31.01c-.24-.14-.53-.22-.85-.22s-.61.07-.85.22c-.24.14-.43.35-.56.62-.13.27-.2.58-.2.93s.07.67.2.93c.13.27.32.47.56.62.24.14.53.22.85.22s.61-.07.85-.22c.24-.14.43-.35.57-.62s.2-.58.2-.93-.07-.67-.2-.93c-.13-.27-.32-.47-.57-.62Z"/>
                                <path class="cls-1" d="M33.04,31.01c-.24-.14-.53-.22-.85-.22s-.61.07-.85.22c-.24.14-.43.35-.56.62-.13.27-.2.58-.2.93s.07.67.2.93c.13.27.32.47.56.62.24.14.53.22.85.22s.61-.07.85-.22c.24-.14.43-.35.57-.62.13-.27.2-.58.2-.93s-.07-.67-.2-.93-.32-.47-.57-.62Z"/>
                                <polygon class="cls-1" points="39.28 33.01 40.67 33.01 39.99 31.14 39.28 33.01"/>
                                <path class="cls-1" d="M24.81,32.87h-1.2v1.45h1.2c.19,0,.35-.06.46-.19.12-.13.17-.3.17-.51,0-.23-.06-.41-.17-.55-.12-.14-.27-.21-.46-.21Z"/>
                                <path class="cls-1" d="M48.54,31.68c0-.19-.03-.35-.1-.48s-.16-.23-.29-.3c-.13-.07-.28-.1-.45-.1h-1.02v1.76h1.02c.17,0,.32-.03.45-.1s.22-.17.29-.3c.07-.13.1-.29.1-.48Z"/>
                                <path class="cls-1" d="M24.88,31.94c.1-.12.15-.27.15-.45,0-.21-.06-.38-.17-.5-.11-.12-.26-.18-.46-.18h-.8v1.32h.85c.18,0,.32-.06.42-.18Z"/>
                                <path class="cls-1" d="M55.59,31.03c-.25-.15-.54-.22-.86-.22h-.66v3.5h.66c.33,0,.62-.07.86-.21s.44-.35.58-.62.21-.57.21-.93-.07-.65-.21-.91-.33-.47-.58-.62Z"/>
                                <path class="cls-1" d="M76.87,27.72H7.29c-2.65,0-4.8,2.15-4.8,4.8v.09c0,2.65,2.15,4.8,4.8,4.8h69.58c2.65,0,4.8-2.15,4.8-4.8v-.09c0-2.65-2.15-4.8-4.8-4.8ZM11.07,33.87c-.21.38-.5.68-.88.89-.38.21-.8.32-1.28.32s-.91-.11-1.28-.32c-.38-.21-.67-.51-.88-.9-.21-.38-.32-.82-.32-1.3s.11-.92.32-1.3c.21-.38.51-.68.88-.89.38-.21.8-.32,1.28.32s.9.11,1.28.32c.38.21.67.51.88.9.21.38.32.82.32,1.3s-.11.92-.32,1.3ZM19,35.08h-.97l-2.31-3.56v3.56h-.87v-5.03h.98l2.3,3.56v-3.56h.87v5.03ZM26.14,34.38c-.12.22-.28.39-.49.52-.21.12-.45.18-.72.18h-2.21v-5.03h1.78c.26,0,.5.06.71.17.21.11.37.28.49.48.12.21.17.44.17.71,0,.18-.05.36-.14.55-.07.14-.15.26-.25.36.06.03.11.06.17.1l.02.02c.18.13.34.3.45.52.12.22.18.44.18.65,0,.28-.06.53-.18.76ZM34.36,33.87c-.21.38-.5.68-.88.89-.38.21-.8.32-1.28.32s-.91-.11-1.28-.32c-.38-.21-.67-.51-.88-.9-.21-.38-.32-.82-.32-1.3s.11-.92.32-1.3c.21-.38.51-.68.88-.89.38-.21.8-.32,1.28.32s.9.11,1.28.32c.38.21.67.51.88.9.21.38.32.82.32,1.3s-.11.92-.32,1.3ZM41.43,35.08l-.48-1.31h-1.94l-.5,1.31h-.93l1.88-5.03h1.06l1.84,5.03h-.93ZM48.6,35.08l-1.17-1.76h-.76v1.76h-.87v-5.03h2.06c.3,0,.57.07.81.2.24.13.42.32.55.56.13.24.2.53.2.84,0,.22-.03.42-.1.61-.06.18-.17.35-.33.5-.15.15-.36.29-.61.41l1.27,1.9h-1.05ZM56.92,33.87c-.22.38-.51.68-.89.89-.38.21-.81.32-1.3.32h-1.54v-5.03h1.54c.49,0,.92.11,1.3.32.38.21.68.51.89.89.22.38.32.81.32,1.3s-.11.93-.32,1.31ZM61.62,35.08h-.87v-5.03h.87v5.03ZM69.46,35.08h-.97l-2.31-3.56v3.56h-.87v-5.03h.98l2.3,3.56v-3.56h.87v5.03ZM77.73,32.88c0,.45-.09.84-.28,1.17-.19.33-.46.59-.8.76-.35.18-.75.27-1.22.27s-.9-.11-1.27-.32-.67-.51-.88-.89c-.21-.38-.32-.82-.32-1.3s.11-.92.32-1.3c.21-.38.51-.67.88-.89.37-.21.8-.32,1.27.32.51,0,.94.11,1.3.34.36.23.63.51.8.84l-.72.39c-.12-.24-.3-.43-.54-.6-.24-.16-.52-.24-.84-.24s-.6.07-.85.22c-.25.14-.43.35-.57.62-.13.27-.2.58-.2.93s.07.67.2.93c.13.27.32.47.57.62.25.14.53.22.85.22.27,0,.51-.05.73-.14.22-.09.39-.22.53-.4.13-.18.2-.41.2-.68h-1.39v-.69h2.24v.46Z"/>
                                <rect class="cls-1" y="24.92" width="84.16" height=".71"/>
                                <path class="cls-1" d="M6.24,8.21c.33.22.66.33,1,.33.57,0,.99-.11,1.26-.34.27-.22.4-.53.4-.92,0-.23-.08-.42-.23-.58-.15-.16-.35-.29-.58-.4-.23-.11-.56-.23-.97-.37-.63-.23-1.15-.45-1.55-.65-.4-.21-.75-.51-1.04-.91-.29-.4-.44-.92-.44-1.55,0-.57.14-1.07.42-1.49.28-.42.68-.75,1.18-.98C6.21.11,6.79,0,7.45,0,7.85,0,8.26.09,8.69.26c.43.17.82.44,1.19.81.37.37.65.83.87,1.38l-1.61.59c-.32-.49-.6-.83-.87-1.03-.27-.2-.54-.3-.81-.3-.29,0-.54.05-.75.15-.21.1-.36.23-.46.4-.15.25-.19.55-.11.9.18.29.44.51.8.68.24.11.58.26,1.01.42.63.25,1.14.48,1.53.69.39.21.73.51,1.01.89.28.38.42.87.42,1.45s-.15,1.1-.44,1.54c-.3.45-.72.79-1.27,1.04-.55.25-1.2.38-1.95.38s-1.4-.2-2.02-.61c-.61-.41-1.14-.98-1.58-1.71l1.54-.88c.42.56.73.95,1.06,1.17Z"/>
                                <path class="cls-1" d="M19.52,1.76h-2.68v8.49h-2.06V1.76h-2.73c0-.97.79-1.76,1.76-1.76h3.95c.97,0,1.76.79,1.76,1.76h0Z"/>
                                <path class="cls-1" d="M29.5,10.25h-2.19l-.92-2.57h-3.72l-.95,2.57h-2.19l3.4-9.19C23.16.42,23.77,0,24.45,0h1.36s3.69,10.25,3.69,10.25ZM25.75,5.92l-1.19-3.37-1.24,3.37h2.43Z"/>
                                <path class="cls-1" d="M36.53,10.25l-2.2-3.35h-1.39v3.35h-2.06V1.62C30.88.73,31.6,0,32.5,0h2.83C35.95,0,36.5.14,36.98.41c.48.28.85.67,1.12,1.18.27.51.41,1.1.41,1.78,0,.44-.05.84-.16,1.2-.1.36-.3.7-.59,1.03-.29.33-.69.64-1.22.94l2.45,3.72h-2.46ZM35.72,4.95c.23-.13.41-.32.54-.57.13-.25.19-.56.19-.93s-.06-.68-.19-.93c-.13-.25-.31-.44-.54-.57-.23-.13-.51-.19-.84-.19h-1.54c-.22,0-.41.18-.41.41v2.98h1.95c.32,0,.6-.06.84-.19Z"/>
                                <path class="cls-1" d="M42.51,8.49h4.34v1.76h-6.4V2.06C40.45.92,41.37,0,42.51,0h0v8.49Z"/>
                                <path class="cls-1" d="M50.51,0v10.25h-2.06V2.06C48.46.92,49.38,0,50.51,0h0Z"/>
                                <path class="cls-1" d="M71.68,10.25h-2.06v-4.38h-4.14v4.38h-2.06V2.06C63.43.92,64.35,0,65.48,0h0v4.11h4.14V0h0c1.14,0,2.06.92,2.06,2.06v8.19Z"/>
                                <path class="cls-1" d="M80.48,1.76h-2.68v8.49h-2.06V1.76h-2.73C73.02.79,73.8,0,74.77,0h3.95c.97,0,1.76.79,1.76,1.76h0Z"/>
                                <path class="cls-1" d="M13.61,22.71h-2.19l-.92-2.57h-3.72l-.95,2.57h-2.19l3.4-9.19c.24-.64.84-1.06,1.52-1.06h1.36l3.69,10.25ZM9.86,18.38l-1.19-3.37-1.24,3.37h2.43Z"/>
                                <path class="cls-1" d="M17.18,12.46v10.25h-2.06v-8.19c0-1.14.92-2.06,2.06-2.06h0Z"/>
                                <path class="cls-1" d="M24.72,22.71l-2.2-3.35h-1.39v3.35h-2.06v-8.63c0-.9.73-1.62,1.62-1.62h2.83c.62,0,1.17.14,1.65.41.48.28.85.67,1.12,1.18.27.51.41,1.1.41,1.78,0,.44-.05.84-.16,1.2-.1.36-.3.7-.59,1.03-.29.33-.69.64-1.22.94l2.45,3.72h-2.46ZM23.91,17.41c.23-.13.41-.32.54-.57.13-.25.19-.56.19-.93s-.06-.68-.19-.93c-.13-.25-.31-.44-.54-.57-.23-.13-.51-.19-.84-.19h-1.54c-.22,0-.41.18-.41.41v2.98h1.95c.32,0,.6-.06.84-.19Z"/>
                                <path class="cls-1" d="M30.7,20.95h4.34v1.76h-6.4v-8.19c0-1.14.92-2.06,2.06-2.06h0v8.49Z"/>
                                <path class="cls-1" d="M38.71,12.46v10.25h-2.06v-8.19c0-1.14.92-2.06,2.06-2.06h0Z"/>
                                <path class="cls-1" d="M49.28,22.71h-2.33l-4.34-6.83v6.83h-2.06v-8.26c0-1.1.89-1.99,1.99-1.99h.33l4.34,6.84v-6.84h0c1.14,0,2.06.92,2.06,2.06v8.19Z"/>
                                <path class="cls-1" d="M58.1,14.22h-4.53c-.22,0-.41.18-.41.41v1.93h4.22v1.76h-4.22v2.64h4.94v1.76h-6.99v-8.63c0-.9.73-1.62,1.62-1.62h5.37v1.76Z"/>
                                <path class="cls-1" d="M62.09,20.67c.33.22.66.33,1,.33.57,0,.99-.11,1.26-.34.27-.22.4-.53.4-.92,0-.23-.08-.42-.23-.58-.15-.16-.35-.29-.58-.4-.23-.11-.56-.23-.97-.37-.63-.23-1.15-.45-1.55-.65-.4-.21-.75-.51-1.04-.91-.29-.4-.44-.92-.44-1.55,0-.57.14-1.07.42-1.49.28-.42.68-.75,1.18-.98.51-.23,1.09-.34,1.75-.34.4,0,.81.09,1.24.26.43.17.82.44,1.19.81.37.37.65.83.87,1.38l-1.61.59c-.32-.49-.6-.83-.87-1.03-.27-.2-.54-.3-.81-.3-.29,0-.54.05-.75.15-.21.1-.36.23-.46.4-.15.25-.19.55-.11.9.18.29.44.51.8.68.24.11.58.26,1.01.42.63.25,1.14.48,1.53.69.39.21.73.51,1.01.89.28.38.42.87.42,1.45s-.15,1.1-.44,1.54c-.3.45-.72.79-1.27,1.04-.55.25-1.2.38-1.95.38s-1.4-.2-2.02-.61c-.61-.41-1.14-.98-1.58-1.71l1.54-.88c.42.56.73.95,1.06,1.17Z"/>
                                <path class="cls-1" d="M76.85,17.46l-3.13-2.97c-.08-.08-.2-.11-.31-.09l-.93.16c-.12.02-.19.16-.12.27l1.79,3.09s0,.1-.05.11l-2.75.49c-.05,0-.1,0-.14-.04l-1.7-1.39c-.08-.07-.19-.09-.29-.07l-.5.09c-.12.02-.19.16-.12.27l1.34,2.31c.3.52.9.8,1.49.69l8.35-1.47c.5-.09.84-.57.75-1.07h0c-.09-.5-.57-.84-1.07-.75l-2.43.43c-.06,0-.11,0-.15-.05Z"/>
                                <path class="cls-1" d="M61.98,1.94l-1.25-.57s-.04-.03-.05-.05l-.57-1.25c-.04-.08-.15-.08-.18,0l-.57,1.25s-.03.04-.05.05l-1.25.57c-.08.04-.08.15,0,.18l1.25.57s.04.03.05.05l.57,1.25c.04.08.15.08.18,0l.57-1.25s.03-.04.05-.05l1.25-.57c.08-.04.08-.15,0-.18Z"/>
                                <path class="cls-1" d="M56.26.39c.08-.04.04-.16-.04-.14-2.36.4-4.15,2.49-4.09,4.99,0,.37.06.72.15,1.07.33-.76.82-1.54,1.47-2.28.08-1.63,1.09-3.01,2.52-3.63Z"/>
                                <path class="cls-1" d="M61.77,5.9c-.6,1.38-1.93,2.38-3.5,2.51.15-.13.3-.27.45-.42,1.7-1.7,2.54-3.75,2.2-5.07.15,1.13-.83,3.03-2.53,4.73-.27.27-.54.52-.82.75-1.42-.12-2.64-.96-3.3-2.14-.36.5-.64.99-.84,1.46-.07.17-.13.34-.18.49.58.71,1.36,1.26,2.24,1.56-.7.33-1.34.48-1.83.41.63.16,1.43.06,2.27-.29.32.08.66.12,1,.13,2.49.06,4.58-1.73,4.99-4.09.01-.09-.11-.12-.14-.04Z"/>
                                <path class="cls-1" d="M55.18,4.45c.85-.85,1.75-1.52,2.58-1.96-.15-.11-.24-.28-.24-.47,0-.07.01-.13.03-.19-.98.36-2.04,1.04-2.99,1.99-2.1,2.1-2.89,4.73-1.76,5.86.03.03.06.05.08.08-.76-.92.24-3.27,2.29-5.32Z"/>
                            </g>
                        </svg>
                    </div>

                    <!-- Passenger Info -->
                    <div>
                        <p class="ticket-label">Passenger</p>
                        <!-- JS will populate this span -->
                        <p id="userName" class="ticket-data text-xl md:text-2xl">
                            <span class="font-semibold" style="color: var(--text-title);">...</span>
                        </p>
                    </div>
                    
                    <!-- Flight & Dest Info -->
                    <div class="flex gap-6">
                        <div>
                            <p class="ticket-label">Flight</p>
                            <p class="ticket-data text-lg">ST-2025</p>
                        </div>
                        <div>
                            <p class="ticket-label">Destination</p>
                            <p class="ticket-data text-lg">Tropical Paradise</p>
                        </div>
                    </div>
                </div>

                <!-- Ticket Stub area -->
                <div class="ticket-stub text-center">
                    <!-- Wrapper for rotated content -->
                    <div class="ticket-stub-content">
                        <p class="ticket-label mb-2">Ticket</p>
                        <!-- Pass card is now nested inside -->
                        <div id="userPassCard" class="tier-pending w-full">
                            <p id="userTier" class="text-2xl font-bold">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cell: Top-Right (Game) -->
            <div id="grid-game" class="dashboard-card flex flex-col game-card">
                <h3 class="font-bold text-xl text-center mb-4 flex-shrink-0" style="color: var(--text-title);">Want to play a game?</h3>
                <div class="text-sm space-y-3 px-2 flex-shrink-0 text-center">
                    <p>üéµ Guess the song from the instrumental!</p>
                    <p>üèÜ Earn points for every correct answer.</p>
                </div>
                <div class="flex-grow flex items-center justify-center pt-6">
                    <a href="game2.html" class="interactive-card" data-label="Guess the Song (Moderate)">
                        <div class="card-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.007 1.916l-7.5 4.125a2.25 2.25 0 01-2.006 0L3.5 15.116A2.25 2.25 0 012.5 13.2V9.45" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9l10.5-3M9 9l-10.5 3m10.5 0v6.553M19.5 6l-10.5 3m10.5 0v6.553M3.5 12.6V15.116A2.25 2.25 0 004.507 17.03l7.5 4.125a2.25 2.25 0 002.006 0l7.5-4.125A2.25 2.25 0 0021.5 15.116V12.6" />
                            </svg>
                        </div>
                        <span class="card-title block font-semibold" style="color: var(--text-title);">Guess the Song</span>
                        <span class="card-subtitle block font-medium">Moderate</span>
                    </a>
                </div>
            </div>

            <!-- Cell: Bottom-Right (Points & History) -->
            <div id="grid-col-3-wrapper" class="flex flex-col" style="gap: var(--base-gap);">
                <div id="grid-history" class="dashboard-card flex flex-col overflow-hidden history-card">
                    <!-- Top Section: Points -->
                    <div class="flex-shrink-0">
                        <div class="flex justify-between items-start" style="border-color: var(--card-border);"> <!-- items-start -->
                            <div class="flex items-center gap-2 md:gap-3">
                                <span class="font-semibold text-base md:text-lg">Points:</span>
                                <span id="userPoints" class="text-3xl md:text-4xl font-bold" style="color: var(--text-title);">0</span>
                            </div>
                        </div>
                    </div>
                    <!-- History Section Title -->
                    <div class="flex-shrink-0 flex justify-between items-center mt-6 pt-4 border-t" style="border-color: var(--card-border);">
                         <h3 class="text-lg font-bold" style="color: var(--text-title);">Points History</h3>
                         <button id="refreshHistoryBtn" class="p-1 rounded-full hover:bg-slate-100"><svg class="h-6 w-6" style="color: var(--text-body);" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M2 12.08c-.006-.862.91-1.356 1.618-.975l.095.058 2.678 1.804c.972.655.377 2.143-.734 2.007l-.117-.02-1.063-.234a8.002 8.002 0 0 0 14.804.605 1 1 0 0 1 1.82.828c-1.987 4.37-6.896 6.793-11.687 5.509A10.003 10.003 0 0 1 2 12.08Zm.903-4.228C4.89 3.482 9.799 1.06 14.59 2.343a10.002 10.002 0 0 1 7.414 9.581c.007.863-.91 1.358-1.617.976l-.096-.058-2.678-1.804c-.972-.655-.377-2.143.734-2.007l.117.02 1.063.234A8.002 8.002 0 0 0 4.723 8.68a1 1 0 1 1-1.82-.828Z" fill="currentColor"/></g></svg></button>
                    </div>
                    <!-- Scrollable List -->
                    <div id="historyList" class="flex-grow overflow-y-auto pt-2">
                        <!-- History items will be injected here by JS -->
                    </div>
                </div>

                <!-- Logout button as a separate element below the card -->
                <button id="logoutButton" 
                        class="w-full text-center py-3 px-6 rounded-xl text-sm font-medium transition-colors 
                               bg-white border border-gray-200 hover:bg-gray-50 
                               text-red-600 hover:text-red-700 shadow-md">
                    Logout
                </button>
            </div>

            <!-- Cell: Bottom-Left (Rewards) -->
            <div id="grid-rewards" class="dashboard-card flex flex-col overflow-hidden rewards-card">
                <h3 class="text-lg font-bold flex-shrink-0" style="color: var(--text-title);">Redeem Rewards</h3>
                <main id="rewardsGrid" class="flex-grow overflow-y-auto pt-4 grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <!-- Reward buttons will be dynamically checked by JS -->
                    <button class="reward-button" data-cost="5" data-label="Candy" data-reward-code="Reward1">
                        <img src="https://placehold.co/128x128/FEF2F2/DC2626?text=ÓÅûÊ∑∑" alt="Candy Icon" class="bg-red-100">
                        <p class="label">Candy</p>
                        <p class="points">5 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="15" data-label="Cookie" data-reward-code="Reward2">
                        <img src="https://placehold.co/128x128/FFFBEB/D97706?text=ÓÅûÊ†π" alt="Cookie Icon" class="bg-amber-100">
                        <p class="label">Cookie</p>
                        <p class="points">15 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="45" data-label="Ramen" data-reward-code="Reward3">
                        <img src="https://placehold.co/128x128/FFF7ED/F97316?text=ÓÅûÈ™®" alt="Ramen Icon" class="bg-orange-100">
                        <p class="label">Ramen</p>
                        <p class="points">45 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                    <button class="reward-button" data-cost="75" data-label="Photocard" data-reward-code="Reward4">
                        <img src="https://placehold.co/128x128/F0F9FF/0284C7?text=ÓÅûËêÑ" alt="Photocard Icon" class="bg-sky-100">
                        <p class="label">Photocard</p>
                        <p class="points">75 pts</p>
                        <p class="quantity"><span class="quantity-value">--</span> left</p>
                        <div class="disabled-overlay">Not enough<br>points</div>
                    </button>
                     <!-- Add more buttons here if needed -->
                </main>
            </div>

        </div>
    </main>
    
    <!-- MODALS (Merged) -->
    
    <!-- General Info Modal (for errors, logout) -->
    <div id="infoModal" class="fullscreen-overlay">
        <div class="popup-card p-6 gap-4 text-center">
            <h3 id="infoModalTitle" class="text-2xl font-bold" style="color: var(--text-title);"></h3>
            <p id="infoModalMessage" class="text-slate-500 break-words"></p>
            <div class="flex items-center justify-center gap-4 mt-4 w-full">
                <!-- NEW: Cancel button for confirmation dialogs -->
                <button id="infoModalCancelBtn" class="modal-button primary !bg-slate-200 !text-slate-700" style="display: none;">Cancel</button>
                <button id="infoModalCloseBtn" class="modal-button primary w-full">OK</button>
            </div>
        </div>
    </div>

    <!-- Redeem Confirmation Modal (from rewards.html) -->
    <div id="redeemModal" class="fullscreen-overlay">
        <div class="popup-card p-6 gap-4 text-center">
            <button id="redeemModalCloseBtn" class="absolute top-3 right-3 p-1 rounded-full hover:bg-slate-100" style="color: var(--text-body);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <img id="redeemModalImage" src="" alt="Reward Image" class="w-32 h-32 md:w-40 md:h-40 object-cover rounded-xl mx-auto">
            <h3 id="redeemModalTitle" class="text-2xl font-bold" style="color: var(--text-title);"></h3>
            <p>Redeem this reward for <strong id="redeemModalPoints" style="color: var(--text-title);"></strong> points?</p>
            <div id="redeemStatus" class="font-semibold mt-2 hidden h-6"></div>
            <div class="flex items-center justify-center gap-4 mt-2 w-full">
                <button id="redeemModalConfirmBtn" class="modal-button primary w-full">Redeem Now</button>
            </div>
        </div>
    </div>
    
  <script>
    // --- DOM Element Store ---
    // Select all DOM elements once on load
    const dom = {}; 

    // --- App Configuration ---
    // GET requests (fetch data) MUST use Google Apps Script
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwb2YDEuFLayiuqShjTN9IkhDOWUInGrJCZWuW4_RQ_lky0lo6Xf_Z7E7SUm0e60oBA/exec"; // IMPORTANT: This URL MUST be correct
    
    // POST requests (submit data) MUST use SheetDB
    const SHEETDB_POST_API_ID = "5ss66fnmfz8vl"; // IMPORTANT: Replace with your SheetDB API ID

    // --- App State ---
    const state = {
        currentUserCode: null,
        currentPoints: 0,
        inventory: {}, // e.g., { Reward1: 15, Reward2: 5, ... }
        isRedeeming: false,
        isDataLoaded: false,
    };

    // --- UI Flow & Data Functions ---

    function showLoading(isLoading, text = "Loading Data...") { 
        if (dom.loadingText) dom.loadingText.textContent = text;
        if (dom.loadingOverlay) dom.loadingOverlay.classList.toggle('visible', isLoading); 
    }

    function redirectToLogin() {
        sessionStorage.removeItem('currentUserCode');
        window.location.href = 'index.html';
    }

    /**
     * Shows a modal. Can be a simple "OK" modal or a "Confirm/Cancel" modal.
     * @param {string} title - The title of the modal.
     * @param {string} message - The message content.
     * @param {function} [onOk] - Optional function to run when OK/Confirm is clicked.
     * @param {boolean} [showCancel=false] - If true, shows a Cancel button.
     */
    function showInfoModal(title, message, onOk, showCancel = false) {
        dom.infoModalTitle.textContent = title;
        dom.infoModalMessage.textContent = message;

        if (showCancel) {
            dom.infoModalCancelBtn.style.display = 'block';
            dom.infoModalCloseBtn.textContent = 'Confirm';
        } else {
            dom.infoModalCancelBtn.style.display = 'none';
            dom.infoModalCloseBtn.textContent = 'OK';
        }

        dom.infoModal.classList.add('visible');

        const close = () => { 
            dom.infoModal.classList.remove('visible'); 
            dom.infoModalCloseBtn.onclick = null;
            dom.infoModalCancelBtn.onclick = null;
        };

        dom.infoModalCloseBtn.onclick = () => {
            close();
            if (onOk) onOk();
        };
        
        dom.infoModalCancelBtn.onclick = close; // Cancel just closes the modal
    }
    
    /**
     * Formats ISO date string to a readable format
     * e.g., "2023-10-27T10:00:00.000Z" -> "Oct 27, 10:00 AM"
     */
    function formatDate(isoString) {
        if (!isoString) return "Just now";
        try {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });
        } catch (e) {
            console.error("Error formatting date:", isoString, e);
            return "---";
        }
    }

    // --- Data Fetching (GET from Google Apps Script) ---
    async function fetchHomePageData(code, isManualRefresh = false) {
      if (isManualRefresh) {
        dom.refreshHistoryBtn?.classList.add('animate-spin');
      }
      if (!state.isDataLoaded) { // Only show full loading screen on first load
        showLoading(true);
      }
    
      try {
        // This action fetches ALL data (user, history, inventory)
        const url = `${GAS_WEB_APP_URL}?action=getHomePageData&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);

        if (!res.ok) throw new Error(`Data refresh failed: ${res.status}`);
        
        const result = await res.json();

        if (result.status !== 'success') {
            throw new Error(result.message || "Invalid user data.");
        }
        
        // --- Process ALL data from the single response ---
        
        // 1. Update User Info & Points
        state.currentPoints = parseInt(result.user?.Points || "0", 10);
        updateUserCard(result.user); // Update welcome/tier card
        dom.userPoints.textContent = state.currentPoints; // Update points in history column

        // 2. Render History
        renderHistoryList(result.history || []);

        // 3. Process Inventory & Update Rewards
        const rawInventoryData = result.inventory || [];
        const prizeNameToQuantityMap = rawInventoryData.reduce((acc, item) => {
            const prizeName = item["Prize"];
            const quantity = item["Remaining Qty"];
            if (prizeName) {
                acc[prizeName] = parseInt(quantity || "0", 10);
            }
            return acc;
        }, {});

        state.inventory = {}; // Reset inventory
        dom.rewardButtons.forEach(button => {
            const rewardCode = button.dataset.rewardCode;
            const prizeLabel = button.dataset.label;
            state.inventory[rewardCode] = prizeNameToQuantityMap[prizeLabel] ?? 0;
        });

        state.isDataLoaded = true;
        updateRewardsUI(); // Update reward buttons (enable/disable)

      } catch (error) {
        console.error("Failed to fetch dashboard data:", error);
        showInfoModal("Data Error", `Failed to load dashboard data: ${error.message}. Returning to login.`, () => {
            redirectToLogin();
        });
      } finally {
        if (isManualRefresh) {
            dom.refreshHistoryBtn?.classList.remove('animate-spin');
        }
        showLoading(false); // Hide loading overlay
      }
    }

    // --- UI Rendering Functions ---

    /**
     * Updates the User Card with Tier and Welcome Message
     */
    function updateUserCard(userData) {
        const tier = userData?.Event1 ? String(userData.Event1).toLowerCase() : 'pending';
        let tierName = tier.charAt(0).toUpperCase() + tier.slice(1);
        if (tier === 'pending') tierName = 'Ticket Pending';
        
        // Reset classes
        dom.userPassCard.className = "tier-pending w-full"; // Start with default
        
        if (tier.includes('economy')) {
            dom.userPassCard.classList.add('tier-economy');
        } else if (tier.includes('business')) {
            dom.userPassCard.classList.add('tier-business');
        } else if (tier.includes('first')) {
            dom.userPassCard.classList.add('tier-first');
        } else {
             dom.userPassCard.classList.add('tier-pending');
        }

        dom.userTier.textContent = tierName;
        // NEW: The JS just updates the name, the "Welcome," text is gone
        dom.userName.querySelector('span').textContent = `${userData?.Name || "Guest"}`;
    }

    /**
     * Renders the scrollable history list using Timestamp
     */
    function renderHistoryList(historyData) {
        if (!historyData || historyData.length === 0) {
            dom.historyList.innerHTML = `<p class="text-center py-8">No points history recorded.</p>`;
            return;
        }
        dom.historyList.innerHTML = ''; 
        const container = document.createElement('div');
        container.className = 'w-full text-sm flex flex-col space-y-2';
        
        // Group by transaction for display
        historyData.forEach(item => {
            const points = parseInt(item.Points, 10) || 0;
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center py-3 border-b';
            row.style.borderColor = 'var(--card-border)';
            
            // Use formatted timestamp. Fallback to Transaction if timestamp is missing.
            const primaryText = item.Timestamp ? formatDate(item.Timestamp) : (item.Transaction || 'Event');
            const secondaryText = item.Timestamp ? (item.Transaction || 'Event') : '';

            row.innerHTML = `
                <div class="flex-grow text-left">
                    <span class="font-semibold block" style="color: var(--text-title);">${primaryText}</span>
                    <span class="text-xs block">${secondaryText}</span>
                </div>
                <span class="font-bold text-lg text-right pl-4 ${points >= 0 ? 'text-green-600' : 'text-red-500'}">${points >= 0 ? '+' : ''}${points}</span>
            `;
            container.appendChild(row);
        });
        dom.historyList.appendChild(container);
    }

    /**
     * Updates Reward Buttons (from rewards.html)
     * Disables buttons based on points and inventory.
     */
    function updateRewardsUI() {
        if (!state.isDataLoaded) return; 

        dom.rewardButtons.forEach(button => {
            const cost = parseInt(button.dataset.cost, 10);
            const rewardCode = button.dataset.rewardCode;
            const quantity = state.inventory[rewardCode] ?? 0;
            const quantityValueEl = button.querySelector('.quantity-value');
            if (quantityValueEl) quantityValueEl.textContent = quantity;

            const disabledOverlay = button.querySelector('.disabled-overlay');
            
            if (quantity <= 0) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Out of Stock";
            } else if (state.currentPoints < cost) {
                button.disabled = true;
                if (disabledOverlay) disabledOverlay.innerHTML = "Not enough<br>points";
            } else {
                button.disabled = false;
            }
        });
    }

    // --- Reward Redemption Functions (from rewards.html) ---

    function showRedeemModal(rewardButton) {
        const { label, cost, rewardCode } = rewardButton.dataset;
        const imgSrc = rewardButton.querySelector('img').src;
        
        dom.redeemModalImage.src = imgSrc;
        dom.redeemModalTitle.textContent = label;
        dom.redeemModalPoints.textContent = cost;
        dom.redeemStatus.classList.add('hidden');
        dom.redeemModal.classList.add('visible');
        
        dom.redeemModalConfirmBtn.onclick = () => redeemReward(rewardCode, parseInt(cost, 10));
    }

    function closeRedeemModal() { 
        dom.redeemModal.classList.remove('visible'); 
        dom.redeemModalConfirmBtn.onclick = null; 
    }

    /**
     * Handles the reward redemption (POST to SheetDB)
     */
    async function redeemReward(rewardCode, cost) {
        if (state.isRedeeming) return;
        state.isRedeeming = true;

        dom.redeemModalConfirmBtn.disabled = true;
        dom.redeemModalConfirmBtn.textContent = 'Redeeming...';

        // Optimistic UI Update: Deduct points and quantity
        const originalPoints = state.currentPoints;
        const originalInventory = JSON.parse(JSON.stringify(state.inventory)); 
        state.currentPoints -= cost;
        if (state.inventory[rewardCode] !== undefined) {
            state.inventory[rewardCode]--;
        }
        updateRewardsUI(); // Update rewards
        dom.userPoints.textContent = state.currentPoints; // Update main points display

        // This payload POSTS to SheetDB
        const correctedPayload = {
            sheet: "History", // Target "History" sheet
            data: [{
                "Access Code": state.currentUserCode,
                "Transaction": `Redeemed ${rewardCode}`, // E: Transaction
                "Points": -cost, // F: Points
                "Timestamp": new Date().toISOString() // G: Timestamp
            }]
        };

        try {
            const response = await fetch(`https://sheetdb.io/api/v1/${SHEETDB_POST_API_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(correctedPayload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            // Success
            dom.redeemStatus.textContent = 'Success! Reward redeemed.';
            dom.redeemStatus.className = 'font-semibold mt-2 text-green-600';
            dom.redeemStatus.classList.remove('hidden');

            setTimeout(() => { closeRedeemModal(); }, 1500);

        } catch (error) {
            console.error('Redemption error:', error);
            
            // Rollback UI on Failure
            state.currentPoints = originalPoints;
            state.inventory = originalInventory;
            updateRewardsUI();
            dom.userPoints.textContent = state.currentPoints;

            dom.redeemStatus.textContent = `Error: Could not redeem.`;
            dom.redeemStatus.className = 'font-semibold mt-2 text-red-500';
            dom.redeemStatus.classList.remove('hidden');

        } finally {
            // Re-sync with server after a delay, regardless of outcome
            setTimeout(() => {
                state.isRedeeming = false; 
                dom.redeemModalConfirmBtn.disabled = false;
                dom.redeemModalConfirmBtn.textContent = 'Redeem Now';
                fetchHomePageData(state.currentUserCode, true); // Re-fetch ALL data
            }, 2000);
        }
    }

    
    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Assign all DOM elements ---
        dom.dashboard = document.getElementById('dashboard');
        dom.userName = document.getElementById('userName');
        dom.userTier = document.getElementById('userTier');
        dom.userPassCard = document.getElementById('userPassCard'); // NEW
        dom.userPoints = document.getElementById('userPoints');
        dom.historyList = document.getElementById('historyList');
        dom.refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        dom.logoutButton = document.getElementById('logoutButton');
        
        // Modals
        dom.infoModal = document.getElementById('infoModal');
        dom.infoModalTitle = document.getElementById('infoModalTitle');
        dom.infoModalMessage = document.getElementById('infoModalMessage');
        dom.infoModalCloseBtn = document.getElementById('infoModalCloseBtn');
        dom.infoModalCancelBtn = document.getElementById('infoModalCancelBtn');
        dom.loadingOverlay = document.getElementById('loadingOverlay');
        dom.loadingText = document.getElementById('loadingText');
        
        // Rewards (Merged)
        dom.rewardsGrid = document.getElementById('rewardsGrid');
        dom.rewardButtons = document.querySelectorAll('.reward-button');
        dom.redeemModal = document.getElementById('redeemModal');
        dom.redeemModalImage = document.getElementById('redeemModalImage');
        dom.redeemModalTitle = document.getElementById('redeemModalTitle');
        dom.redeemModalPoints = document.getElementById('redeemModalPoints');
        dom.redeemModalCloseBtn = document.getElementById('redeemModalCloseBtn');
        dom.redeemModalConfirmBtn = document.getElementById('redeemModalConfirmBtn'); 
        dom.redeemStatus = document.getElementById('redeemStatus');

        // --- 2. Check User Session ---
        state.currentUserCode = sessionStorage.getItem('currentUserCode');
        if (!state.currentUserCode) {
            redirectToLogin();
            return;
        }

        // --- 3. Show Dashboard & Fetch Data ---
        dom.dashboard.style.display = 'flex';
        setTimeout(() => { dom.dashboard.style.opacity = 1; }, 50);
        
        fetchHomePageData(state.currentUserCode); // Initial data fetch

        // --- 4. Add Event Listeners ---
        
        // Logout
        dom.logoutButton.addEventListener('click', () => {
            showInfoModal("Logout", "Are you sure you want to log out?", () => {
                redirectToLogin();
            }, true); // true = show cancel button
        });
      
        // Manual Refresh
        dom.refreshHistoryBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.currentUserCode) fetchHomePageData(state.currentUserCode, true);
        });

        // Reward Button Clicks
        dom.rewardsGrid.addEventListener('click', (e) => {
            const rewardButton = e.target.closest('.reward-button');
            if (rewardButton && !rewardButton.disabled) {
                showRedeemModal(rewardButton);
            }
        });

        // Redeem Modal Close Buttons
        dom.redeemModalCloseBtn.addEventListener('click', closeRedeemModal);
        dom.redeemModal.addEventListener('click', (e) => {
            if (e.target === dom.redeemModal) closeRedeemModal();
        });
    });
  </script>
</body>
</html>