<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Starlight Dashboard</title>
</head>
<body>
  <!-- Your existing HTML remains unchanged -->
  <!-- ... -->

  <script>
    const splashScreen = document.getElementById('splashScreen');
    const loginScreen = document.getElementById('loginScreen');
    const dashboard = document.getElementById('dashboard');
    const accessCodeInput = document.getElementById('accessCodeInput');
    const accessCodeEnterBtn = document.getElementById('accessCodeEnterBtn');
    const accessCodeError = document.getElementById('accessCodeError');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const userNameEl = document.getElementById('userName');
    const userPointsEl = document.getElementById('userPoints');
    const progressContainer = document.getElementById('progressContainer');
    const historyList = document.getElementById('historyList');
    const historyPopup = document.getElementById('historyPopup');
    const rewardsPage = document.getElementById('rewardsPage');

    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbwxqqcZfyMXvjYyrnZ68v0fUJx7RQvNIOAf9blHR_yahgQZaJEVMyFwzqnIJz5sf2QU9w/exec";

    function showSplashScreen() {
      splashScreen.classList.add('visible');
      loginScreen.classList.remove('visible');
    }

    function showLoginScreen() {
      splashScreen.classList.remove('visible');
      loginScreen.classList.add('visible');
      resetInactivityTimer();
    }

    let inactivityTimer = null;
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(showSplashScreen, 30000);
    }

    async function handleLogin() {
      const code = accessCodeInput.value.trim();
      if (!code) {
        accessCodeError.textContent = "Please enter an access code.";
        accessCodeError.classList.remove('hidden');
        return;
      }

      loadingIndicator.classList.remove('hidden');
      accessCodeError.classList.add('hidden');
      accessCodeEnterBtn.disabled = true;

      try {
        const url = `${GOOGLE_SHEET_URL}?code=${code}`;
        const res = await fetch(url);
        const json = await res.json();

        if (!json.user || !json.user.Name) {
          throw new Error("Invalid code");
        }

        loginScreen.classList.remove('visible');
        dashboard.style.display = 'flex';
        setTimeout(() => dashboard.style.opacity = 1, 50);

        updateDashboardUI(json.user, json.history);
      } catch (error) {
        accessCodeError.textContent = "Invalid Access Code. Please try again.";
        accessCodeError.classList.remove('hidden');
      } finally {
        loadingIndicator.classList.add('hidden');
        accessCodeEnterBtn.disabled = false;
      }
    }

    function updateDashboardUI(userData, historyData) {
      userNameEl.textContent = userData.Name || "Guest";
      userPointsEl.textContent = userData.Points || "0";

      renderProgressBar(userData);
      renderHistoryList(historyData || []);
    }

    function renderProgressBar(data) {
      progressContainer.innerHTML = '';
      const steps = [
        { key: 'Event1', label: 'Onboarding' },
        { key: 'Event2', label: 'Take Off' },
        { key: 'Event3', label: 'Touchdown' }
      ];

      steps.forEach((step, index) => {
        const completed = data[step.key] === true || data[step.key] === "TRUE";
        const stepEl = document.createElement('div');
        stepEl.className = `progress-step flex flex-col items-center ${completed ? 'completed' : ''}`;
        stepEl.innerHTML = `
          <div class="stamp-circle">
            ${completed
              ? `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-10 w-10\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2.5\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" /></svg>`
              : `<span class="text-3xl font-bold">${index + 1}</span>`
            }
          </div>
          <div class="event-label ${!completed ? 'label-blurred' : ''}">${step.label}</div>
        `;
        progressContainer.appendChild(stepEl);

        if (index < steps.length - 1) {
          const line = document.createElement('div');
          line.className = `progress-line ${completed ? 'completed' : ''}`;
          progressContainer.appendChild(line);
        }
      });
    }

    function renderHistoryList(historyData) {
      if (!historyData || historyData.length === 0) {
        historyList.innerHTML = '<p class="text-center text-slate-500 mt-6">No points history yet.</p>';
        return;
      }

      const sorted = [...historyData].sort((a, b) => {
        const aTime = a.Time || "";
        const bTime = b.Time || "";
        return bTime.localeCompare(aTime);
      });

      historyList.innerHTML = sorted.map(item => `
        <div class="flex justify-between items-center py-3 border-b border-slate-100">
          <div>
            <p class="font-semibold text-slate-700">${item.Game}</p>
            <p class="text-xs text-slate-400">${item.Time}</p>
          </div>
          <p class="font-bold text-lg text-green-500">+${item.Points}</p>
        </div>
      `).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
      showSplashScreen();
      setTimeout(showLoginScreen, 2500);

      ['click', 'keypress', 'mousemove'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));
      splashScreen.addEventListener('click', showLoginScreen);
      accessCodeEnterBtn.addEventListener('click', handleLogin);
      accessCodeInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleLogin());

      document.getElementById('showHistoryBtn').addEventListener('click', () => historyPopup.classList.add('visible'));
      document.getElementById('closeHistoryBtn').addEventListener('click', () => historyPopup.classList.remove('visible'));
      document.getElementById('showRewardsBtn').addEventListener('click', () => rewardsPage.classList.add('visible'));
      document.getElementById('closeRewardsBtn').addEventListener('click', () => rewardsPage.classList.remove('visible'));
    });
  </script>
</body>
</html>
