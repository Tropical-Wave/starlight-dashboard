<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>K-Pop Quiz</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#89B3D9"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="K-Pop Quiz">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¶</text></svg>">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Audio Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        /* --- UNIFIED Color Palette & Font from game2.html --- */
        :root {
            --background: #89B3D9; 
            --card-bg: #FFFFFF;
            --card-border: #E1E5E3;
            --primary-accent: #89B3D9;
            --cta-accent: #F4D35E;
            --text-title: #2D3748;
            --text-body: #5F7D97;
            --text-on-cta: #1C2B26;
            --tier1-green-bg: #E6F3E9;
            --tier1-green-border: #C8E2D0;
            --tier1-green-text: #2A745C;
            --base-font-size: 16px;
            --base-padding: 1.5rem;
        }

        /* --- Base Styles --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--primary-accent);
            background: linear-gradient(135deg, var(--primary-accent) 0%, #7aa8cc 100%);
            font-family: 'Inter', sans-serif; 
            color: var(--text-body);
            font-size: var(--base-font-size);
            box-sizing: border-box;
        }
        *, *:before, *:after { box-sizing: inherit; }

        /* --- Screen Container --- */
        .screen-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s;
            overflow: hidden;
            padding: var(--base-padding);
        }
        @media (max-width: 767px) { .screen-container { padding: 1rem; } }
        .screen-container.active { opacity: 1; visibility: visible; }

        /* --- Dashboard Card Style (Used for Intro/Result) --- */
        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            border: 1px solid var(--card-border); 
            box-shadow: 0 8px 16px rgba(45, 55, 72, 0.1), 0 4px 6px rgba(45, 55, 72, 0.05);
            padding: clamp(1.5rem, 5vw, 2.5rem);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        /* --- Modal Button Style (Used for Start/Done) --- */
        .modal-button { 
            text-align: center; padding: 1rem; font-weight: 600; border-radius: 0.75rem; 
            transition: all 0.2s ease; border: none; cursor: pointer; width: 100%;
            font-size: 1.1rem; line-height: 1.5rem;
        }
        .modal-button.primary { 
            background-color: var(--cta-accent); color: var(--text-on-cta); 
            box-shadow: 0 4px 8px rgba(244, 211, 94, 0.3);
        }
        .modal-button.primary:hover:not(:disabled) { opacity: 0.9; transform: translateY(-2px); }
        .modal-button.primary:disabled { 
            background: #94A3B8; color: white; opacity: 0.7; cursor: wait; transform: none; box-shadow: none; 
        }
        
        /* --- Intro Screen --- */
        #introScreen .title {
            font-size: clamp(2rem, 8vw, 2.5rem); font-weight: 700;
            color: var(--text-title); line-height: 1.2;
        }
        #introScreen .subtitle {
            font-size: clamp(1.1rem, 4vw, 1.25rem); font-weight: 500;
            color: var(--text-body); margin-top: 0.5rem;
        }
        #introScreen .instructions-list {
            text-align: left; font-size: clamp(0.9rem, 3vw, 1rem); color: var(--text-body);
            line-height: 1.6; margin-top: 1.5rem; padding-left: 20px;
        }
        #introScreen .instructions-list li { margin-bottom: 0.5rem; }
        #startButton { margin-top: 2rem; max-width: 300px; margin-left: auto; margin-right: auto; }

        /* Back Button - Top Left */
        .back-button {
            position: absolute; top: 1.5rem; left: 1.5rem;
            background-color: rgba(255, 255, 255, 0.8); border-radius: 9999px;
            padding: 0.75rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: background-color 0.2s, transform 0.1s;
            z-index: 10;
        }
        @media (max-width: 767px) { .back-button { top: 1rem; left: 1rem; padding: 0.6rem; } }
        .back-button:hover { background-color: rgba(255, 255, 255, 1); transform: translateY(-1px); }

        /* --- Game Screen --- */
        #gameScreen { justify-content: flex-start; gap: 1.5rem; height: 100dvh; }
        
        .top-game-section {
            display: flex; align-items: center; justify-content: center; width: 100%;
            max-width: 900px; position: relative; padding: 0 4rem;
        }
        #gameScreen .header-quiz {
            font-size: clamp(2.5rem, 8vw, 3.5rem); font-weight: 700; line-height: 1;
            color: white; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Countdown Timer */
        .countdown-timer-container {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            width: clamp(50px, 12vw, 60px); height: clamp(50px, 12vw, 60px);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: clamp(1.2rem, 4vw, 1.5rem); color: var(--text-title);
            background-color: var(--card-bg); border-radius: 50%; border: 3px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 5;
        }
        .countdown-timer-svg {
            position: absolute; top: -3px; left: -3px; width: calc(100% + 6px); height: calc(100% + 6px);
            transform: rotate(-90deg); overflow: visible;
        }
        .countdown-circle-bg { stroke: var(--card-border); stroke-width: 5; fill: none; }
        .countdown-circle-progress {
            stroke: var(--cta-accent); stroke-width: 5; fill: none; transition: stroke-dasharray 1s linear;
        }

        /* --- NEW: Question Container (replaces Lottie container) --- */
        #questionContainer {
            width: 100%;
            max-width: 900px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 16px rgba(45, 55, 72, 0.1);
            padding: clamp(1.5rem, 5vw, 2.5rem);
            text-align: center;
            min-height: 150px;
        }
        #questionText {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-title);
        }

        /* Choices Section */
        .choices-section {
            flex-grow: 0; flex-shrink: 0; display: grid; grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 1rem; width: 100%; max-width: 900px;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in;
        }
        @media (max-width: 767px) { .choices-section { gap: 0.75rem; } }
        .choices-section.visible { opacity: 1; visibility: visible; }

        /* Choice Button */
        .choice-button {
            background-color: white; border: 1px solid var(--card-border);
            border-radius: 1.5rem; transition: all 0.2s ease-out;
            text-decoration: none; display: flex; align-items: center; justify-content: center;
            padding: clamp(1rem, 3vw, 1.5rem); min-height: 90px;
            cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            font-size: clamp(1rem, 3.8vw, 1.25rem); font-weight: 600;
            color: var(--text-title); text-align: center; line-height: 1.3;
        }
        .choice-button:hover:not(:disabled) { 
            transform: translateY(-4px); border-color: var(--primary-accent);
            box-shadow: 0 8px 20px -5px rgba(137, 179, 217, 0.3); 
        }
        .choice-button:disabled { cursor: not-allowed; opacity: 0.7; }
        
        /* Answer feedback colors */
        .choice-button.correct {
            background-color: var(--tier1-green-bg); border-color: var(--tier1-green-border);
            box-shadow: 0 0 15px rgba(42, 116, 92, 0.4); color: var(--tier1-green-text);
        }
        .choice-button.wrong {
            background-color: #FEE2E2; border-color: #FCA5A5;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); color: #B91C1C;
        }

        /* Result Screen */
        #resultScreen .message {
            font-size: clamp(2rem, 8vw, 2.5rem); font-weight: 700;
            color: var(--text-title); margin-bottom: 0.5rem;
        }
        #resultScreen .subtitle-message {
            font-size: clamp(1.1rem, 4vw, 1.25rem); color: var(--text-body); margin-bottom: 1.5rem;
        }
        #resultScreen .points-earned-text {
            font-size: clamp(1.2rem, 5vw, 1.5rem); font-weight: 700;
            color: var(--tier1-green-text); margin-bottom: 2rem;
        }
        #resultScreen .done-button-container { width: 100%; max-width: 300px; margin: auto; }
        .result-footer { margin-top: 2rem; font-size: 0.75rem; color: #A0AEC0; }
        .result-footer a { color: var(--text-body); text-decoration: underline; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Intro Screen -->
    <div id="introScreen" class="screen-container active">
        <a href="home.html" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        <div class="dashboard-card">
            <h1 class="title">K-Pop Quiz</h1>
            <p class="subtitle">(Multiple Choice)</p>
            <ul class="instructions-list">
                <li>Test your K-Pop knowledge!</li>
                <li>Answer 5 questions.</li>
                <li>Each round lasts 7 seconds.</li>
                <li>Earn points for each correct answer!</li>
            </ul>
            <button id="startButton" class="modal-button primary" disabled>Loading Quiz...</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen-container hidden">
        <div class="top-game-section">
            <h2 class="header-quiz">K-Pop Quiz</h2>
            <div id="countdownTimerContainer" class="countdown-timer-container hidden">
                <span id="countdownText">5</span>
                <svg class="countdown-timer-svg" viewBox="0 0 36 36">
                    <path class="countdown-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path id="countdownCircleProgress" class="countdown-circle-progress" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
            </div>
        </div>
        
        <!-- Question Container -->
        <div id="questionContainer">
            <p id="questionText"></p>
        </div>

        <!-- Choices -->
        <div id="choicesSection" class="choices-section">
            <button class="choice-button" data-choice-index="0"></button>
            <button class="choice-button" data-choice-index="1"></button>
            <button class="choice-button" data-choice-index="2"></button>
            <button class="choice-button" data-choice-index="3"></button>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="screen-container hidden">
        <div class="dashboard-card">
            <h2 id="resultMessage" class="message"></h2>
            <p id="resultSubtitle" class="subtitle-message"></p>
            <p id="pointsEarnedText" class="points-earned-text hidden"></p>
            <div class="done-button-container">
                <button id="doneButton" class="modal-button primary">Done</button>
            </div>
            <footer class="result-footer">
                Sound Effect by <a href="https://pixabay.com/users/n2kstudio-17715924/" target="_blank">N2kStudio</a> from <a href="https://pixabay.com/" target="_blank">Pixabay</a>
            </footer>
        </div>
    </div>

<script>
    // --- Constants and DOM Elements ---
    const QUIZ_QUESTION_COUNT = 5;
    const TOTAL_ROUND_DURATION = 7000;
    const CHOICES_DISPLAY_DURATION = 5000;

    const introScreen = document.getElementById('introScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');
    const startButton = document.getElementById('startButton');
    const questionText = document.getElementById('questionText');
    const choicesSection = document.getElementById('choicesSection');
    const choiceButtons = document.querySelectorAll('.choice-button');
    const countdownTimerContainer = document.getElementById('countdownTimerContainer');
    const countdownText = document.getElementById('countdownText');
    const countdownCircleProgress = document.getElementById('countdownCircleProgress');
    const resultMessage = document.getElementById('resultMessage');
    const resultSubtitle = document.getElementById('resultSubtitle');
    const pointsEarnedText = document.getElementById('pointsEarnedText');
    const doneButton = document.getElementById('doneButton');

    // --- Sound Effects (using Tone.js) ---
    const correctSoundPlayer = new Tone.Player({ url: 'correct.wav', autostart: false }).toDestination();
    const wrongSoundPlayer = new Tone.Player({ url: 'wrong.wav', autostart: false }).toDestination();
    const backgroundMusicPlayer = new Tone.Player({ url: 'music-for-game-fun-kid-game-163649.mp3', loop: true, autostart: false }).toDestination();
    const gameDoneSoundPlayer = new Tone.Player({ url: 'done.wav', autostart: false }).toDestination();
    const timerTickSound = new Tone.MembraneSynth({
        pitchDecay: 0.05, octaves: 0.5, oscillator: { type: 'sine' },
        envelope: { attack: 0.002, decay: 0.2, sustain: 0.0, release: 0.05 }
    }).toDestination();
    const buzzerSound = new Tone.NoiseSynth().toDestination();
    buzzerSound.envelope.attack = 0.005;
    buzzerSound.envelope.decay = 0.2;
    buzzerSound.envelope.sustain = 0;
    buzzerSound.envelope.release = 0.3;

    // --- Game State Variables ---
    let allQuestions = [];
    let shuffledQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let roundTimer = null;
    let choicesTimer = null;
    let countdownTimer = null;
    let gameActive = false;
    let audioLoaded = false;

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Game Flow Functions ---
    async function initializeGame() {
        startButton.textContent = "Loading Quiz...";
        startButton.disabled = true;

        try {
            const [questionsResponse] = await Promise.all([
                fetch('questions.json'),
                new Promise(resolve => {
                    Tone.loaded().then(() => {
                        audioLoaded = true;
                        console.log("All audio assets loaded.");
                        resolve();
                    }).catch(e => {
                        audioLoaded = false;
                        console.error("Error loading audio assets:", e);
                        resolve(); 
                    });
                })
            ]);
            
            if (!questionsResponse.ok) throw new Error(`HTTP error! status: ${questionsResponse.status}`);
            allQuestions = await questionsResponse.json();
            resetGame();
            startButton.textContent = "Start Quiz";
            startButton.disabled = false;
            console.log("Quiz questions and assets ready.");

        } catch (error) {
            console.error('Failed to initialize game:', error);
            startButton.textContent = "Quiz Not Ready";
            alert('Failed to load quiz resources. Please try again.');
            window.location.href = 'home.html';
        }
    }

    function resetGame() {
        score = 0;
        currentQuestionIndex = 0;
        shuffledQuestions = shuffleArray([...allQuestions]).slice(0, QUIZ_QUESTION_COUNT);
    }

    function showScreen(screenToShow) {
        [introScreen, gameScreen, resultScreen].forEach(screen => {
            screen.classList.remove('active');
            screen.classList.add('hidden');
        });
        screenToShow.classList.remove('hidden');
        setTimeout(() => screenToShow.classList.add('active'), 10);
    }

    async function startQuiz() {
        gameActive = true;
        resetGame();
        showScreen(gameScreen);
        
        if (audioLoaded) {
            try {
                await Tone.start();
                backgroundMusicPlayer.start();
            } catch (e) {
                console.error("Failed to start audio:", e);
            }
        }

        loadQuestion();
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', handlePopState);
    }

    function handlePopState() {
        if (gameActive) {
            const confirmExit = window.confirm("Exiting will reset your progress. Are you sure?");
            if (confirmExit) {
                if(backgroundMusicPlayer.state === 'started') backgroundMusicPlayer.stop();
                window.removeEventListener('popstate', handlePopState);
                window.location.href = 'home.html';
            } else {
                history.pushState(null, null, location.href);
            }
        }
    }

    function adjustQuestionFontSize() {
        const questionLength = questionText.textContent.length;
        questionText.style.fontSize = ''; // Reset
        if (questionLength > 90) questionText.style.fontSize = 'clamp(1.3rem, 4vw, 1.7rem)';
        else if (questionLength > 60) questionText.style.fontSize = 'clamp(1.5rem, 5vw, 2.0rem)';
    }
    
    function loadQuestion() {
        if (currentQuestionIndex >= shuffledQuestions.length) {
            endQuiz();
            return;
        }

        const questionData = shuffledQuestions[currentQuestionIndex];
        questionText.textContent = questionData.question;
        adjustQuestionFontSize();

        choicesSection.classList.remove('visible');
        countdownTimerContainer.classList.add('hidden');
        resetChoiceButtons();

        clearTimeout(roundTimer);
        clearTimeout(choicesTimer);
        clearInterval(countdownTimer);
        
        const radius = 15.9155;
        const circumference = 2 * Math.PI * radius;
        countdownCircleProgress.style.transition = 'none';
        countdownCircleProgress.style.strokeDasharray = `${circumference}, ${circumference}`;

        choicesTimer = setTimeout(() => {
            displayChoices(questionData.choices);
            startCountdownTimer(CHOICES_DISPLAY_DURATION / 1000);
        }, TOTAL_ROUND_DURATION - CHOICES_DISPLAY_DURATION);

        roundTimer = setTimeout(() => handleAnswer(null, false), TOTAL_ROUND_DURATION);
    }

    function displayChoices(choices) {
        choicesSection.classList.add('visible');
        const shuffledCurrentChoices = shuffleArray([...choices]);

        choiceButtons.forEach((button, index) => {
            button.textContent = shuffledCurrentChoices[index];
            button.onclick = () => handleAnswer(button.textContent, button.textContent === shuffledQuestions[currentQuestionIndex].correctAnswer);
            button.disabled = false;
        });
        countdownTimerContainer.classList.remove('hidden');
    }

    function startCountdownTimer(durationInSeconds) {
        let timeRemaining = durationInSeconds;
        const radius = 15.9155;
        const circumference = 2 * Math.PI * radius;

        countdownCircleProgress.getBoundingClientRect();
        countdownCircleProgress.style.transition = `stroke-dasharray 1s linear`;
        
        requestAnimationFrame(() => {
             const progress = (timeRemaining / durationInSeconds) * circumference;
             countdownCircleProgress.style.strokeDasharray = `${progress}, ${circumference}`;
        });

        countdownText.textContent = timeRemaining;

        countdownTimer = setInterval(() => {
            timeRemaining--;
            if (timeRemaining < 0) {
                clearInterval(countdownTimer);
                return;
            }
            countdownText.textContent = timeRemaining;

            if (timeRemaining <= 3 && timeRemaining > 0 && audioLoaded) {
                try { timerTickSound.triggerAttackRelease('G4', '16n'); } catch(e) {}
            }
            
            const progress = (timeRemaining / durationInSeconds) * circumference;
            countdownCircleProgress.style.strokeDasharray = `${progress}, ${circumference}`;
        }, 1000);
    }

    function handleAnswer(selectedAnswer, isCorrect) {
        if (!gameActive) return; 
        gameActive = false;

        clearTimeout(roundTimer);
        clearTimeout(choicesTimer);
        clearInterval(countdownTimer);
        countdownTimerContainer.classList.add('hidden');

        const questionData = shuffledQuestions[currentQuestionIndex];
        let correctlyAnswered = false;

        choiceButtons.forEach(button => {
            if (button.textContent === questionData.correctAnswer) {
                button.classList.add('correct');
                if (selectedAnswer === questionData.correctAnswer) correctlyAnswered = true;
            } else if (button.textContent === selectedAnswer) {
                button.classList.add('wrong');
            }
            button.disabled = true;
        });

        if (correctlyAnswered) {
            score++;
            if(audioLoaded) try { correctSoundPlayer.start(); } catch (e) {}
        } else {
            if(audioLoaded) try { wrongSoundPlayer.start(); buzzerSound.triggerAttackRelease('8n', 'C2'); } catch (e) {}
        }

        setTimeout(() => {
            currentQuestionIndex++;
            gameActive = true;
            loadQuestion();
        }, 1500);
    }

    function resetChoiceButtons() {
        choiceButtons.forEach(button => {
            button.textContent = '';
            button.classList.remove('correct', 'wrong');
            button.disabled = true;
        });
    }

    function endQuiz() {
        gameActive = false;
        if(backgroundMusicPlayer.state === 'started') backgroundMusicPlayer.stop();
        if(audioLoaded) gameDoneSoundPlayer.start();
        window.removeEventListener('popstate', handlePopState);

        showScreen(resultScreen);
        doneButton.disabled = false;

        resultMessage.textContent = "Quiz Complete!";
        resultSubtitle.textContent = `You answered ${score} out of ${QUIZ_QUESTION_COUNT} correctly.`;
        pointsEarnedText.textContent = `You earned ${score} points!`;
        pointsEarnedText.classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeGame();
        startButton.addEventListener('click', startQuiz);
        doneButton.addEventListener('click', () => {
            doneButton.disabled = true;
            window.location.href = 'home.html';
        });
    });

    window.addEventListener('beforeunload', (event) => {
        if (gameActive) {
            event.preventDefault();
            event.returnValue = '';
        }
    });
</script>
</body>
</html>
