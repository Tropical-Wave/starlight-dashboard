<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Guess the Song</title>

    <!-- PWA Meta Tags from home.html -->
    <meta name="theme-color" content="#89B3D9"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Guess Song">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽµ</text></svg>">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font is unified to "Inter" from home.html -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Audio Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- ADDED: LottieFile Script -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>

    <style>
        /* --- UNIFIED Color Palette & Font from home.html --- */
        :root {
            /* Core Palette */
            --background: #89B3D9; 
            --card-bg: #FFFFFF; /* "white" */
            --card-border: #E1E5E3;
            --primary-accent: #89B3D9; /* Brand Blue */
            --cta-accent: #F4D35E;
            --text-title: #2D3748;
            --text-body: #5F7D97;
            --text-on-cta: #1C2B26;

            /* Tier Colors */
            --tier1-green-bg: #E6F3E9;
            --tier1-green-border: #C8E2D0;
            --tier1-green-text: #2A745C;

            /* Sizing variables */
            --base-font-size: 16px;
            --base-padding: 1.5rem;
            --base-gap: 1.5rem;
        }

        /* --- Base Styles --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* Prevent body scroll */
            /* FIXED: Using exact background from home.html */
            background-color: var(--primary-accent);
            background: linear-gradient(135deg, var(--primary-accent) 0%, #7aa8cc 100%);
            font-family: 'Inter', sans-serif; 
            color: var(--text-body);
            font-size: var(--base-font-size);
            box-sizing: border-box;
        }
        *, *:before, *:after { box-sizing: inherit; }

        /* --- Screen Container --- */
        .screen-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s;
            overflow: hidden;
            padding: var(--base-padding);
        }
        @media (max-width: 767px) {
            .screen-container {
                padding: 1rem;
            }
        }
        .screen-container.active {
            opacity: 1; visibility: visible;
        }

        /* --- Dashboard Card Style (Used for Intro/Result) --- */
        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            border: 1px solid var(--card-border); 
            box-shadow: 0 8px 16px rgba(45, 55, 72, 0.1), 0 4px 6px rgba(45, 55, 72, 0.05);
            padding: clamp(1.5rem, 5vw, 2.5rem);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        /* --- Modal Button Style (Used for Start/Done) --- */
        .modal-button { 
            text-align: center; 
            padding: 1rem; 
            font-weight: 600; 
            border-radius: 0.75rem; 
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            line-height: 1.5rem; /* Ensure text doesn't jump when changing */
        }
        .modal-button.primary { 
            background-color: var(--cta-accent); 
            color: var(--text-on-cta); 
            box-shadow: 0 4px 8px rgba(244, 211, 94, 0.3);
        }
        .modal-button.primary:hover:not(:disabled) { 
            opacity: 0.9; 
            transform: translateY(-2px);
        }
        .modal-button.primary:disabled { 
            background: #94A3B8; /* Muted color */
            color: white;
            opacity: 0.7; 
            cursor: wait; 
            transform: none;
            box-shadow: none;
        }
        
        /* --- Intro Screen --- */
        #introScreen .title {
            font-size: clamp(2rem, 8vw, 2.5rem);
            font-weight: 700;
            color: var(--text-title);
            line-height: 1.2;
        }
        #introScreen .subtitle {
            font-size: clamp(1.1rem, 4vw, 1.25rem);
            font-weight: 500;
            color: var(--text-body);
            margin-top: 0.5rem;
        }
        #introScreen .instructions-list {
            text-align: left;
            font-size: clamp(0.9rem, 3vw, 1rem);
            color: var(--text-body);
            line-height: 1.6;
            margin-top: 1.5rem;
            padding-left: 20px;
        }
        #introScreen .instructions-list li {
            margin-bottom: 0.5rem;
        }
        #startButton {
            margin-top: 2rem;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Back Button - Top Left */
        .back-button {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 9999px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s;
            z-index: 10;
        }
        @media (max-width: 767px) {
            .back-button {
                top: 1rem;
                left: 1rem;
                padding: 0.6rem;
            }
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        /* --- Game Screen --- */
        #gameScreen {
            /* MODIFIED: Make screen a column that justifies content from top to bottom */
            justify-content: space-between;
            gap: 1.5rem;
            height: 100dvh; /* Ensure it takes full viewport height */
        }
        
        /* Top Game Section: Header and Timer */
        .top-game-section {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            position: relative;
            padding: 0 4rem; /* Space for back button and timer */
            margin-bottom: 1rem; /* Add some space below header */
        }
        #gameScreen .header-quiz {
            /* MODIFIED: Increased font size */
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            font-weight: 700;
            line-height: 1;
            color: white; /* Light text on dark bg */
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-grow: 0; /* Do not grow */
            flex-shrink: 0; /* Do not shrink */
        }

        /* Countdown Timer */
        .countdown-timer-container {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: clamp(50px, 12vw, 60px);
            height: clamp(50px, 12vw, 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            color: var(--text-title);
            background-color: var(--card-bg);
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 5;
        }
        .countdown-timer-svg {
            position: absolute; top: -3px; left: -3px;
            width: calc(100% + 6px); height: calc(100% + 6px);
            transform: rotate(-90deg);
            overflow: visible;
        }
        .countdown-circle-bg {
            stroke: var(--card-border);
            stroke-width: 5;
            fill: none;
        }
        .countdown-circle-progress {
            stroke: var(--cta-accent); /* Yellow accent for timer */
            stroke-width: 5;
            fill: none;
            transition: stroke-dasharray 1s linear;
        }

        /* --- REMOVED: Music Note Animation --- */
        /* #musicNoteContainer { ... } */
        /* .music-note { ... } */
        /* @keyframes dance { ... } */

        /* --- NEW: Lottie Animation Container --- */
        #lottieContainer {
            width: 100%;
            /* This container now fills all available space */
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 200px; /* Ensure it has at least some space */
        }
        #lottieContainer dotlottie-wc {
            /* --- CSS UPDATED AS REQUESTED --- */
            /* Fully responsive, fills width, respects max height */
            width: 100%; /* Fill the horizontal width */
            height: auto; /* Scale height proportionally */
            max-height: 60vh; /* Prevent from being too tall on large screens */
            
            /* REMOVED: aspect-ratio: 1 / 1; */
            /* REMOVED: max-width: 600px; */
            /* REMOVED: height: 100%; */
            /* REMOVED: max-height: 80vh; */
        }

        /* Choices Section */
        .choices-section {
            /* MODIFIED: This section no longer grows, it sits at the bottom */
            flex-grow: 0;
            flex-shrink: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 900px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in;
        }
        @media (max-width: 767px) {
            .choices-section {
                gap: 0.75rem;
            }
        }
        .choices-section.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Choice Button (Styled like reward-button from home.html) */
        .choice-button {
            background-color: white; 
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            transition: all 0.2s ease-out;
            position: relative;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(1rem, 3vw, 1.5rem); 
            /* MODIFIED: Slightly taller buttons */
            min-height: 90px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .choice-button:hover:not(:disabled) { 
            transform: translateY(-4px); 
            border-color: var(--primary-accent);
            box-shadow: 0 8px 20px -5px rgba(137, 179, 217, 0.3); 
        }
        .choice-button:disabled { 
            cursor: not-allowed; 
            opacity: 0.7; 
        }
        
        .song-title {
            font-size: clamp(1rem, 3.8vw, 1.25rem);
            font-weight: 600;
            color: var(--text-title);
            text-align: center;
            line-height: 1.3;
        }
        .artist-name {
            font-size: clamp(0.8rem, 2.8vw, 1rem);
            font-weight: 400;
            color: var(--text-body);
            margin-top: 0.25rem;
            text-align: center;
        }

        /* Answer feedback colors (from home.html tier styles) */
        .choice-button.correct {
            background-color: var(--tier1-green-bg);
            border-color: var(--tier1-green-border);
            box-shadow: 0 0 15px rgba(42, 116, 92, 0.4);
        }
        .choice-button.correct .song-title,
        .choice-button.correct .artist-name {
            color: var(--tier1-green-text);
        }
        .choice-button.wrong {
            background-color: #FEE2E2; /* Light red */
            border-color: #FCA5A5; /* Red border */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }
        .choice-button.wrong .song-title {
            color: #B91C1C; /* Dark red text */
        }

        /* Result Screen */
        #resultScreen .message {
            font-size: clamp(2rem, 8vw, 2.5rem);
            font-weight: 700;
            color: var(--text-title);
            margin-bottom: 0.5rem;
        }
        #resultScreen .subtitle-message {
            font-size: clamp(1.1rem, 4vw, 1.25rem);
            color: var(--text-body);
            margin-bottom: 1.5rem;
        }
        #resultScreen .points-earned-text {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            font-weight: 700;
            color: var(--tier1-green-text); /* Green from home.html */
            margin-bottom: 2rem;
        }
        #resultScreen .done-button-container {
            width: 100%;
            max-width: 300px;
            /* FIXED: Add auto margins to center the container */
            margin-left: auto;
            margin-right: auto;
        }
        .result-footer {
            margin-top: 2rem;
            font-size: 0.75rem;
            color: #A0AEC0; /* Lighter text-body */
        }
        .result-footer a {
            color: var(--text-body);
            text-decoration: underline;
        }

        /* Generic utilities */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>

    <!-- Intro Screen -->
    <div id="introScreen" class="screen-container active">
        <a href="home.html" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        <div class="dashboard-card">
            <h1 class="title">Guess the Song</h1>
            <p class="subtitle">(Audio Quiz)</p>
            <ul class="instructions-list">
                <li>A 10-second audio snippet will play.</li>
                <li>Choices appear 5 seconds into the audio.</li>
                <li>You have 10 seconds to guess.</li>
                <li>Answer 10 questions. Earn 1 point per correct answer!</li>
            </ul>
            <button id="startButton" class="modal-button primary" disabled>Loading Quiz...</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen-container hidden">
        <a href="home.html" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        
        <div class="top-game-section">
            <h2 id="gameTitleHeader" class="header-quiz">Guess the Song</h2>
            <div id="countdownTimerContainer" class="countdown-timer-container hidden">
                <span id="countdownText">10</span>
                <svg class="countdown-timer-svg" viewBox="0 0 36 36">
                    <path class="countdown-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path id="countdownCircleProgress" class="countdown-circle-progress" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
            </div>
        </div>

        <!-- NEW: Lottie Animation Container -->
        <div id="lottieContainer">
            <dotlottie-wc 
                src="https://lottie.host/d810ce3b-8621-49bc-a6f3-e82270634f4b/Y3kUuXAeSq.lottie" 
                autoplay 
                loop
                background="transparent">
            </dotlottie-wc>
        </div>

        <!-- Music Note Animation Container (REMOVED) -->
        <!-- <div id="musicNoteContainer"> ... </div> -->

        <!-- Choices -->
        <div id="choicesSection" class="choices-section">
            <button class="choice-button" data-choice-index="0"></button>
            <button class="choice-button" data-choice-index="1"></button>
            <button class="choice-button" data-choice-index="2"></button>
            <button class="choice-button" data-choice-index="3"></button>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="screen-container hidden">
        <div class="dashboard-card">
            <h2 id="resultMessage" class="message">Quiz Complete!</h2>
            <p id="resultSubtitle" class="subtitle-message">You got 0 out of 10 correct.</p>
            <p id="pointsEarnedText" class="points-earned-text">You earned 0 points!</p>
            <div class="done-button-container">
                <button id="doneButton" class="modal-button primary">Done</button>
            </div>
            <footer class="result-footer">
                Sound Effect by <a href="https://pixabay.com/users/n2kstudio-17715924/?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=163649" target="_blank" rel="noopener noreferrer">N2kStudio</a> from <a href="https://pixabay.com//?utm_source=link-attribution&utm_medium=referral&utm_campaign=music&utm_content=163649" target="_blank" rel="noopener noreferrer">Pixabay</a>
                <br>
                <!-- MODIFIED: Updated Lottie attribution -->
                Lottie Animation by <a href="https://lottiefiles.com/user/143583" target="_blank" rel="noopener noreferrer">Jignesh Gajjar</a> on <a href="https://lottiefiles.com/animations/sound-wave-iW9k3M9iL6" target="_blank" rel="noopener noreferrer">LottieFiles</a>
            </footer>
        </div>
    </div>

<script>
    // --- Constants and DOM Elements ---
    const SHEETDB_POST_API_ID = "5ss66fnmfz8vl"; // From home.html
    const QUIZ_QUESTION_COUNT = 10;
    const POINTS_PER_ANSWER = 1; // Scoring logic
    const SONG_PLAYBACK_DURATION = 10000;
    const CHOICES_APPEAR_DELAY = 5000;
    const CHOICES_DISPLAY_DURATION = 10000;
    const TOTAL_ROUND_DURATION = CHOICES_APPEAR_DELAY + CHOICES_DISPLAY_DURATION;

    const introScreen = document.getElementById('introScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');
    const startButton = document.getElementById('startButton');
    const choicesSection = document.getElementById('choicesSection');
    const choiceButtons = document.querySelectorAll('.choice-button');
    const countdownTimerContainer = document.getElementById('countdownTimerContainer');
    const countdownText = document.getElementById('countdownText');
    const countdownCircleProgress = document.getElementById('countdownCircleProgress');
    const resultMessage = document.getElementById('resultMessage');
    const resultSubtitle = document.getElementById('resultSubtitle');
    const pointsEarnedText = document.getElementById('pointsEarnedText');
    const doneButton = document.getElementById('doneButton');
    
    // LOTTIEFILE container (RENAMED)
    const lottieContainer = document.getElementById('lottieContainer');

    // --- Sound Effects (using Tone.js) ---
    // We wrap sound playback in try...catch blocks to prevent errors if Tone.js fails
    const correctSoundPlayer = new Tone.Player({ url: 'correct.wav', autostart: false }).toDestination();
    const wrongSoundPlayer = new Tone.Player({ url: 'wrong.wav', autostart: false }).toDestination();
    const gameDoneSoundPlayer = new Tone.Player({ url: 'done.wav', autostart: false }).toDestination();
    const songSnippetPlayer = new Tone.Player({ autostart: false }).toDestination();
    const timerTickSound = new Tone.MembraneSynth({
        pitchDecay: 0.05, octaves: 0.5, oscillator: { type: 'sine' },
        envelope: { attack: 0.002, decay: 0.2, sustain: 0.0, release: 0.05 }
    }).toDestination();
    const buzzerSound = new Tone.NoiseSynth().toDestination();
    buzzerSound.envelope.attack = 0.005;
    buzzerSound.envelope.decay = 0.2;
    buzzerSound.envelope.sustain = 0;
    buzzerSound.envelope.release = 0.3;

    // --- Game State Variables ---
    let allSongs = [];
    let shuffledSongs = [];
    let currentQuestionIndex = 0;
    let finalScore = 0; // Use 'finalScore' to avoid conflict
    let roundTimer = null;
    let choicesTimer = null;
    let countdownInterval = null;
    let gameActive = false;
    let audioLoaded = false;
    let currentUserCode = null; // Store user code

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- Game Flow Functions ---
    async function initializeGame() {
        // Check for user code from session storage
        currentUserCode = sessionStorage.getItem('currentUserCode');
        if (!currentUserCode) {
            alert('User session not found. Returning to home.');
            window.location.href = 'home.html';
            return;
        }

        startButton.textContent = "Loading Quiz...";
        startButton.disabled = true;

        try {
            const [songsResponse] = await Promise.all([
                fetch('songs.json'),
                new Promise(resolve => {
                    Tone.loaded().then(() => {
                        audioLoaded = true;
                        console.log("Audio assets loaded.");
                        resolve();
                    }).catch(e => {
                        audioLoaded = false;
                        console.error("Error loading audio assets:", e);
                        resolve(); // Resolve anyway so game can start (silently)
                    });
                })
            ]);
            
            if (!songsResponse.ok) {
                throw new Error(`HTTP error! status: ${songsResponse.status} - Could not find songs.json`);
            }
            allSongs = await songsResponse.json();
            resetGame();
            startButton.textContent = "Start Quiz";
            startButton.disabled = false;
            console.log("Quiz songs and assets ready.");

        } catch (error) {
            console.error('Failed to initialize game:', error);
            startButton.textContent = "Quiz Not Ready";
            alert('Failed to load quiz resources. Please check your files and internet connection.');
            window.location.href = 'home.html';
        }
    }

    function resetGame() {
        finalScore = 0;
        currentQuestionIndex = 0;
        shuffledSongs = shuffleArray([...allSongs]).slice(0, QUIZ_QUESTION_COUNT);
    }

    function showScreen(screenToShow) {
        [introScreen, gameScreen, resultScreen].forEach(screen => {
            screen.classList.remove('active');
            screen.classList.add('hidden');
        });
        screenToShow.classList.remove('hidden');
        setTimeout(() => screenToShow.classList.add('active'), 10);
    }

    async function startQuiz() {
        gameActive = true;
        resetGame();
        showScreen(gameScreen);
        
        if (audioLoaded) {
            try { await Tone.start(); } catch (e) { console.error("Failed to start Tone.js audio context:", e); }
        }

        loadQuestion();
        // Handle browser back button during quiz
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', handlePopState);
    }

    function handlePopState(event) {
        if (gameActive) {
            const confirmExit = window.confirm("Are you sure you want to quit? Your progress will be lost.");
            if (confirmExit) {
                gameActive = false;
                if(songSnippetPlayer.state === 'started') songSnippetPlayer.stop();
                window.removeEventListener('popstate', handlePopState);
                history.back(); // Go back to home.html
            } else {
                // Stay on the page
                history.pushState(null, null, location.href);
            }
        }
    }
    
    async function loadQuestion() {
        if (currentQuestionIndex >= shuffledSongs.length) {
            endQuiz();
            return;
        }

        const songData = shuffledSongs[currentQuestionIndex];

        // 1. Reset UI
        choicesSection.classList.remove('visible');
        countdownTimerContainer.classList.add('hidden');
        lottieContainer.classList.remove('hidden'); // Show Lottie
        resetChoiceButtons();

        // 2. Clear timers
        clearTimeout(roundTimer);
        clearTimeout(choicesTimer);
        clearInterval(countdownInterval);

        // 3. Reset countdown timer visual
        countdownText.textContent = CHOICES_DISPLAY_DURATION / 1000;
        const radius = 15.9155;
        const circumference = 2 * Math.PI * radius;
        countdownCircleProgress.style.transition = `none`;
        countdownCircleProgress.style.strokeDasharray = `${circumference}, ${circumference}`;

        // 4. Stop previous song and play new one
        if (songSnippetPlayer.state === 'started') songSnippetPlayer.stop();

        if (audioLoaded) {
            try {
                await songSnippetPlayer.load(`audio/${songData.audio}`);
                songSnippetPlayer.start(0, 0, SONG_PLAYBACK_DURATION / 1000);
            } catch (e) {
                console.error("Error loading or playing song snippet:", e);
                handleAnswer(null, false); // Fail the question and move on
                return;
            }
        } else {
            console.warn("Audio context not ready, cannot play song snippet.");
            handleAnswer(null, false);
            return;
        }

        // 5. Set new timers
        // Timer to show choices
        choicesTimer = setTimeout(() => {
            displayChoices(songData.choices);
            countdownTimerContainer.classList.remove('hidden');
            startCountdownTimer(CHOICES_DISPLAY_DURATION / 1000);
            lottieContainer.classList.add('hidden'); // Hide Lottie
        }, CHOICES_APPEAR_DELAY);

        // Timer for the whole round (fail-safe)
        roundTimer = setTimeout(() => {
            handleAnswer(null, false); // Time ran out
        }, TOTAL_ROUND_DURATION);
    }

    function displayChoices(choices) {
        choicesSection.classList.add('visible');
        const shuffledCurrentChoices = shuffleArray([...choices]);

        choiceButtons.forEach((button, index) => {
            const choiceText = shuffledCurrentChoices[index];
            const parts = choiceText.split(' - ');
            const songTitle = parts[0];
            const artistName = parts.length > 1 ? parts.slice(1).join(' - ') : '';

            button.innerHTML = `<span class="song-title">${songTitle}</span><span class="artist-name">${artistName}</span>`;
            button.onclick = () => handleAnswer(choiceText, choiceText === shuffledSongs[currentQuestionIndex].correctAnswer);
            button.disabled = false;
        });
    }

    function startCountdownTimer(durationInSeconds) {
        let timeRemaining = durationInSeconds;
        const radius = 15.9155;
        const circumference = 2 * Math.PI * radius;

        // Force a reflow to apply the reset
        countdownCircleProgress.getBoundingClientRect(); 
        
        countdownCircleProgress.style.transition = `stroke-dasharray 1s linear`;

        // Wait a frame before starting animation
        requestAnimationFrame(() => {
             const progress = (timeRemaining / durationInSeconds) * circumference;
             countdownCircleProgress.style.strokeDasharray = `${progress}, ${circumference}`;
        });

        countdownText.textContent = timeRemaining;

        countdownInterval = setInterval(() => {
            timeRemaining--;
            if (timeRemaining < 0) {
                clearInterval(countdownInterval);
                return;
            }
            countdownText.textContent = timeRemaining;

            // Play tick sound on last 3 seconds
            if (timeRemaining <= 3 && timeRemaining > 0 && audioLoaded) {
                try { timerTickSound.triggerAttackRelease('G4', '16n'); } catch(e) {}
            }
            
            const progress = (timeRemaining / durationInSeconds) * circumference;
            countdownCircleProgress.style.strokeDasharray = `${progress}, ${circumference}`;

        }, 1000);
    }

    function handleAnswer(selectedAnswer, isCorrect) {
        if (!gameActive) return; // Prevent double-clicks
        gameActive = false; // Lock game during feedback

        // 1. Stop all timers and audio
        clearTimeout(roundTimer);
        clearTimeout(choicesTimer);
        clearInterval(countdownInterval);
        countdownTimerContainer.classList.add('hidden');
        lottieContainer.classList.add('hidden');
        if (songSnippetPlayer.state === 'started') songSnippetPlayer.stop();

        // 2. Show feedback on buttons
        const songData = shuffledSongs[currentQuestionIndex];
        let correctlyAnswered = false;

        choiceButtons.forEach(button => {
            const buttonFullText = button.querySelector('.song-title').textContent + ' - ' + button.querySelector('.artist-name').textContent;
            const originalCorrectAnswer = songData.correctAnswer;

            if (buttonFullText.trim() === originalCorrectAnswer.trim()) {
                button.classList.add('correct');
                if (selectedAnswer && selectedAnswer.trim() === originalCorrectAnswer.trim()) {
                    correctlyAnswered = true;
                }
            } else if (selectedAnswer && buttonFullText.trim() === selectedAnswer.trim()) {
                button.classList.add('wrong');
            }
            button.disabled = true; // Disable all buttons
        });

        // 3. Play sounds and update score
        if (correctlyAnswered) {
            finalScore++; // Score is 1 point per answer
            if(audioLoaded) { try { correctSoundPlayer.start(); } catch (e) {} }
        } else {
            if(audioLoaded) { try { wrongSoundPlayer.start(); buzzerSound.triggerAttackRelease('8n', 'C2'); } catch (e) {} }
        }

        // 4. Go to next question after a delay
        setTimeout(() => {
            currentQuestionIndex++;
            gameActive = true; // Unlock game for next round
            loadQuestion();
        }, 1500); // 1.5 second feedback
    }

    function resetChoiceButtons() {
        choiceButtons.forEach(button => {
            button.innerHTML = '';
            button.classList.remove('correct', 'wrong');
            button.disabled = true;
        });
    }

    function endQuiz() {
        gameActive = false;
        if(songSnippetPlayer.state === 'started') songSnippetPlayer.stop();
        if(audioLoaded) { try { gameDoneSoundPlayer.start(); } catch(e) {} }
        window.removeEventListener('popstate', handlePopState);

        // Show results
        showScreen(resultScreen);
        doneButton.disabled = false;
        doneButton.textContent = "Done";

        // Updated scoring message logic
        resultMessage.textContent = "Quiz Complete!";
        resultSubtitle.textContent = `You answered ${finalScore} out of ${QUIZ_QUESTION_COUNT} correctly.`;
        pointsEarnedText.textContent = `You earned ${finalScore * POINTS_PER_ANSWER} points!`;
        pointsEarnedText.classList.remove('hidden');

        // IMPORTANT: We do NOT send points here.
        // The "Done" button will handle it.
    }

    /**
     * POSTS the final score to SheetDB.
     * This function is now called by the "Done" button.
     */
    async function sendPointsToSheetDB() {
        if (!currentUserCode) {
            console.error("No current user code found. Cannot send points.");
            resultSubtitle.textContent += "\n(Error: Could not save points - no user code)";
            throw new Error("No user code"); // Throw error to stop the "Done" button
        }
        
        // Only send if score > 0
        if (finalScore <= 0) {
            console.log("No points earned, skipping send.");
            return; // Return a success (nothing to do)
        }

        // FIXED: Payload to match user request exactly
        const payload = {
            sheet: "History", // Sheet 2
            data: [{
                "Access Code": currentUserCode,        // Column A
                "Transaction": "Guess the Song",       // Column D
                "Points": finalScore * POINTS_PER_ANSWER, // Column E (the final score)
                "Timestamp": new Date().toISOString()  // Column F
            }]
        };

        try {
            const response = await fetch(`https://sheetdb.io/api/v1/${SHEETDB_POST_API_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`SheetDB API error: ${response.status} - ${errorBody}`);
            }

            const result = await response.json();
            console.log('Points sent to SheetDB:', result);
            // Return success

        } catch (error) {
            console.error('Failed to send points to SheetDB:', error);
            // Append error message to subtitle
            resultSubtitle.textContent += "\n(Error saving points. Please tell staff.)";
            // Return a failure
            throw error; // Re-throw the error so the "Done" button knows it failed
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeGame();
        
        startButton.addEventListener('click', startQuiz);

        // FIXED: "Done" button listener
        doneButton.addEventListener('click', async () => {
            doneButton.disabled = true;
            doneButton.textContent = "Saving...";

            try {
                // Wait for the sendPoints function to complete.
                // It will handle the logic of skipping if score is 0.
                await sendPointsToSheetDB();
                
                // If it succeeds (or skips), redirect
                window.location.href = 'home.html';
                
            } catch (error) {
                // If it fails, log it and re-enable the button
                console.error("Failed to save score, not redirecting.", error);
                doneButton.disabled = false;
                doneButton.textContent = "Done (Save Failed)";
                // You can add a more user-friendly alert here
                alert("Error saving your score. Please try again or contact staff.");
            }
        });
    });

    // Handle page close/refresh
    window.addEventListener('beforeunload', (event) => {
        if (gameActive) {
            event.preventDefault();
            event.returnValue = ''; // Standard for most browsers
        }
    });

</script>
</body>
</html>